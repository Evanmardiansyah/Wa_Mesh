<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval';">
    
    <title>Material Mesh</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        /* --- MATERIAL YOU THEME (PASTEL) --- */
        :root {
            --md-bg: #F2F1F6;
            --md-surface: #FFFFFF;
            --md-primary: #6750A4;
            --md-primary-container: #EADDFF;
            --md-on-primary-container: #21005D;
            --md-secondary-container: #E8DEF8;
            --md-text: #1C1B1F;
            --md-subtext: #49454F;
            --radius-xl: 28px;
            --radius-l: 16px;
        }

        [data-theme="dark"] {
            --md-bg: #141218;
            --md-surface: #1D1B20;
            --md-primary: #D0BCFF;
            --md-primary-container: #4F378B;
            --md-on-primary-container: #EADDFF;
            --md-secondary-container: #4A4458;
            --md-text: #E6E1E5;
            --md-subtext: #CAC4D0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; font-family: 'Google Sans', sans-serif;
            background: var(--md-bg); color: var(--md-text);
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; padding-top: env(safe-area-inset-top);
        }

        /* --- TYPOGRAPHY & BUTTONS --- */
        h1 { font-size: 32px; font-weight: 400; margin: 0 0 10px 0; }
        h2 { font-size: 22px; font-weight: 500; margin: 0; }
        
        .btn-large {
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
            height: 56px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; font-weight: 500; border: none; width: 100%;
            gap: 10px; cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .btn-large:active { transform: scale(0.98); opacity: 0.8; }

        /* --- CARDS --- */
        .card {
            background: var(--md-surface);
            padding: 20px; border-radius: var(--radius-xl);
            margin-bottom: 12px; display: flex; align-items: center; gap: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        
        .avatar {
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--md-secondary-container);
            color: var(--md-text);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; flex-shrink: 0;
        }

        /* --- SETUP SCREEN --- */
        #view-setup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--md-bg); z-index: 200;
            display: flex; flex-direction: column; padding: 30px;
            overflow-y: auto;
        }
        
        .input-pill {
            background: var(--md-surface); border: none;
            height: 60px; border-radius: 30px; padding: 0 24px;
            font-size: 18px; width: 100%; margin-bottom: 30px;
            color: var(--md-text); outline: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .avatar-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 40px;
        }
        .av-item {
            aspect-ratio: 1; border-radius: 20px;
            background: var(--md-surface);
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; border: 2px solid transparent; cursor: pointer;
        }
        .av-item.selected {
            border-color: var(--md-primary);
            background: var(--md-primary-container);
        }

        /* --- MAIN APP --- */
        #view-app { display: none; flex-direction: column; height: 100%; }

        header { padding: 20px 24px; }
        .chip {
            display: inline-flex; align-items: center; gap: 8px;
            background: var(--md-surface); padding: 8px 16px;
            border-radius: 12px; font-size: 14px; font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #list-area { flex: 1; overflow-y: auto; padding: 0 20px 100px 20px; }

        /* --- BOTTOM NAV (PILL STYLE) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--md-surface);
            padding: 16px 24px 30px 24px; /* Extra padding for bottom safe area */
            display: flex; justify-content: space-around;
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            width: 60px; cursor: pointer;
        }
        .nav-pill {
            width: 64px; height: 32px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        .nav-item.active .nav-pill { background: var(--md-primary-container); }
        .nav-item.active .material-icons-round { color: var(--md-on-primary-container); }
        .nav-label { font-size: 12px; font-weight: 500; color: var(--md-subtext); }

        /* --- CHAT ROOM --- */
        #view-chat {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--md-bg); z-index: 100;
            display: none; flex-direction: column;
        }
        .chat-appbar {
            padding: 16px 24px; background: var(--md-surface);
            display: flex; align-items: center; gap: 16px;
            border-radius: 0 0 24px 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        #msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        .bubble {
            max-width: 75%; padding: 14px 18px; border-radius: 20px;
            font-size: 16px; line-height: 1.4;
        }
        .me { align-self: flex-end; background: var(--md-primary); color: #FFF; border-bottom-right-radius: 4px; }
        .other { align-self: flex-start; background: var(--md-surface); color: var(--md-text); border-bottom-left-radius: 4px; }
        
        .input-bar {
            padding: 16px; background: var(--md-surface);
            display: flex; gap: 12px; align-items: center;
            border-radius: 24px 24px 0 0;
        }
    </style>
</head>
<body>

    <div id="view-setup">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <div style="font-size:60px; margin-bottom:20px;">âœ¨</div>
            <h1>Halo!</h1>
            <p style="color:var(--md-subtext); font-size:18px; margin-bottom:40px;">
                Selamat datang di Mesh.<br>Chat tanpa internet, desain cantik.
            </p>
            
            <input type="text" id="setup-name" class="input-pill" placeholder="Nama Kamu">
            
            <p style="margin-left:10px; color:var(--md-subtext);">Pilih Karakter</p>
            <div class="avatar-grid" id="setup-avatars"></div>
        </div>
        
        <button class="btn-large" onclick="finishSetup()">
            MULAI SEKARANG <span class="material-icons-round">arrow_forward</span>
        </button>
        <div id="debug" style="text-align:center; font-size:11px; margin-top:10px; color:gray;">Menunggu Izin...</div>
    </div>

    <div id="view-app">
        <header>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h1 style="font-size:28px;">Radar</h1>
                    <div style="color:var(--md-subtext); font-size:14px;" id="head-user">User</div>
                </div>
                <div class="chip" onclick="startEngine(true)">
                    <span class="material-icons-round" style="color:#10b981; font-size:16px;">circle</span>
                    <span id="status-txt">Aktif</span>
                </div>
            </div>
        </header>

        <div id="list-area">
            <div style="margin-top:50px; text-align:center; opacity:0.5;">
                <span class="material-icons-round" style="font-size:64px; color:#D0BCFF;">wifi_tethering</span>
                <p>Mencari teman di sekitar...</p>
                <button class="btn-large" style="width:200px; margin:20px auto; height:40px; font-size:14px;" onclick="startEngine(true)">
                    SCAN ULANG
                </button>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active">
                <div class="nav-pill"><span class="material-icons-round">radar</span></div>
                <span class="nav-label">Radar</span>
            </div>
            <div class="nav-item" onclick="toggleTheme()">
                <div class="nav-pill"><span class="material-icons-round">palette</span></div>
                <span class="nav-label">Tema</span>
            </div>
        </div>
    </div>

    <div id="view-chat">
        <div class="chat-appbar">
            <span class="material-icons-round" onclick="closeChat()">arrow_back_ios_new</span>
            <div class="avatar" id="chat-av" style="width:40px; height:40px; font-size:20px;">?</div>
            <div>
                <div style="font-weight:500; font-size:18px;" id="chat-name">User</div>
                <div style="font-size:12px; color:var(--md-primary);">Terhubung via BLE</div>
            </div>
        </div>
        <div id="msgs"></div>
        <div class="input-bar">
            <input type="text" id="inp-msg" class="input-pill" style="margin:0; height:50px; font-size:16px;" placeholder="Ketik pesan...">
            <div style="background:var(--md-primary); color:white; width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center;" onclick="sendMsg()">
                <span class="material-icons-round">send</span>
            </div>
        </div>
    </div>

    <script src="cordova.js"></script>
    <script>
        // --- BITCHAT CORE UUID ---
        const SERVICE_UUID = "6E400001-B5A3-F393-E0A9-E50E24DCCA9E"; 
        const CHAR_UUID    = "6E400002-B5A3-F393-E0A9-E50E24DCCA9E";

        let user = { name:"", avatar:"ðŸ˜Š", id:"" };
        let ble = null;
        let devices = {};
        let activeAddr = null;

        document.addEventListener('deviceready', () => {
            ble = window.bluetoothle;
            renderAvatars();
            checkLogin();
        }, false);

        // --- UI LOGIC ---
        const AVATARS = ["ðŸ˜Ž","ðŸ˜Š","ðŸ±","ðŸ¶","ðŸ¦","ðŸ¤–","ðŸ‘»","ðŸ‘½"];
        let tempAv = "ðŸ˜Ž";

        function renderAvatars() {
            let h = AVATARS.map(a => `<div class="av-item" onclick="pick('${a}',this)">${a}</div>`).join('');
            document.getElementById('setup-avatars').innerHTML = h;
            document.querySelector('.av-item').classList.add('selected');
        }
        function pick(a, el) {
            tempAv = a;
            document.querySelectorAll('.av-item').forEach(x=>x.classList.remove('selected'));
            el.classList.add('selected');
        }
        function toggleTheme() {
            if(document.body.getAttribute('data-theme')==='dark') document.body.removeAttribute('data-theme');
            else document.body.setAttribute('data-theme','dark');
        }

        function finishSetup() {
            let n = document.getElementById('setup-name').value.trim();
            if(!n) return alert("Isi nama dulu bos!");
            user = { name:n, avatar:tempAv, id:Math.floor(Math.random()*9999).toString() };
            localStorage.setItem('mat_mesh_user', JSON.stringify(user));
            checkLogin();
        }

        function checkLogin() {
            let s = localStorage.getItem('mat_mesh_user');
            if(s) {
                user = JSON.parse(s);
                document.getElementById('view-setup').style.display='none';
                document.getElementById('view-app').style.display='flex';
                document.getElementById('head-user').innerText = `Halo, ${user.name}`;
                initPermissions();
            }
        }

        // --- ENGINE AGRESIF (BIAR NEMBUS REALME/SAMSUNG) ---
        function initPermissions() {
            const p = cordova.plugins.permissions;
            const list = [
                p.ACCESS_FINE_LOCATION, 
                p.ACCESS_COARSE_LOCATION, 
                p.BLUETOOTH_SCAN, 
                p.BLUETOOTH_ADVERTISE, 
                p.BLUETOOTH_CONNECT
            ];
            
            document.getElementById('debug').innerText = "Request Permission...";
            // Force start even if denied (Fix for Android 11 Go false negative)
            p.requestPermissions(list, () => startEngine(false), () => startEngine(false));
        }

        function startEngine(isRestart) {
            if(isRestart) {
                document.getElementById('status-txt').innerText = "Restarting...";
                ble.stopScan(() => {}, () => {});
                ble.stopAdvertising(() => {}, () => {});
            }

            ble.initialize((res) => {
                if(res.status === 'enabled') {
                    document.getElementById('status-txt').innerText = "Aktif";
                    startAdvertising();
                    startScanning();
                } else {
                    document.getElementById('status-txt').innerText = "Mati";
                    ble.enable(); // Paksa nyala
                }
            }, { request:true, statusReceiver:false });
        }

        // 1. IKLAN (AGRESIF)
        function startAdvertising() {
            ble.initializePeripheral({ request:true }, (res) => {
                if(res.status === 'enabled') {
                    ble.addService({
                        service: SERVICE_UUID,
                        characteristics: [{ 
                            uuid: CHAR_UUID, permissions: {read:true, write:true}, 
                            properties: {read:true, write:true, notify:true} 
                        }]
                    }, () => {
                        // SETTING PENTING: High Power & Include Name
                        ble.startAdvertising({
                            services:[SERVICE_UUID], service:SERVICE_UUID, 
                            name:user.name, 
                            mode:"lowLatency", // Mode Gaming (Cepat)
                            txPowerLevel:"high", // Sinyal Kuat
                            connectable:true,
                            includeDeviceName:true // Biar nama muncul di scan HP lain
                        }, 
                        () => console.log("Iklan OK"), 
                        (e) => console.log("Iklan Gagal", e));
                    }, (e) => console.log("Service Gagal", e));
                }
            }, null);
        }

        // 2. SCAN (AGRESIF)
        function startScanning() {
            ble.startScan({ 
                services:[SERVICE_UUID], 
                scanMode:"lowLatency", // Scan terus-menerus
                matchMode:"aggressive" // Tangkap sinyal lemah sekalipun
            }, (res) => {
                if(res.status === 'scanResult') renderDev(res);
            }, (e) => console.log("Scan Gagal", e));
        }

        function renderDev(d) {
            if(devices[d.address]) return;
            devices[d.address] = d;

            let name = d.name || "Unknown";
            // Filter nama kosong
            if(name === "Unknown" && !d.rssi) return;

            let area = document.getElementById('list-area');
            if(area.innerText.includes("Mencari")) area.innerHTML = "";

            let html = `
            <div class="card" onclick="chatOpen('${d.address}', '${name}')">
                <div class="avatar"><span class="material-icons-round">person</span></div>
                <div style="flex:1">
                    <div style="font-weight:bold; font-size:18px;">${name}</div>
                    <div style="font-size:12px; color:var(--md-subtext);">Sinyal: ${d.rssi} dBm</div>
                </div>
                <span class="material-icons-round" style="color:var(--md-primary);">chat_bubble</span>
            </div>`;
            area.innerHTML += html;
        }

        // --- CHAT LOGIC ---
        function chatOpen(addr, name) {
            activeAddr = addr;
            document.getElementById('view-chat').style.display = 'flex';
            document.getElementById('chat-name').innerText = name;
            document.getElementById('msgs').innerHTML = "";
            
            ble.connect({ address:addr }, (res) => {
                if(res.status === 'connected') {
                    ble.subscribe({ address:addr, service:SERVICE_UUID, characteristic:CHAR_UUID }, (d) => {
                        if(d.value) addBubble(atob(d.value), 'other');
                    });
                }
            }, () => {});
        }

        function sendMsg() {
            let t = document.getElementById('inp-msg').value;
            if(!t) return;
            let b64 = btoa(t);
            ble.write({ address:activeAddr, service:SERVICE_UUID, characteristic:CHAR_UUID, value:b64, type:"noResponse" }, () => {
                addBubble(t, 'me');
                document.getElementById('inp-msg').value = "";
            });
        }

        function addBubble(t, w) {
            let d = document.createElement('div');
            d.className = `bubble ${w}`; d.innerText = t;
            document.getElementById('msgs').appendChild(d);
        }

        function closeChat() {
            document.getElementById('view-chat').style.display='none';
            if(activeAddr) ble.disconnect({address:activeAddr});
        }
    </script>
</body>
</html>
