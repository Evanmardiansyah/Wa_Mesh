<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval';">
    
    <title>Messenger Mesh</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME SYSTEM --- */
        :root {
            --primary: #2563eb;
            --bg-app: #f8f9fa;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --nav-bg: #ffffff;
            --me-bubble: #2563eb;
            --me-text: #fff;
        }
        [data-theme="dark"] {
            --primary: #60a5fa;
            --bg-app: #111827;
            --bg-card: #1f2937;
            --text-main: #f3f4f6;
            --text-sub: #9ca3af;
            --border: #374151;
            --nav-bg: #1f2937;
            --me-bubble: #3b82f6;
        }

        body { margin:0; font-family:'Inter',sans-serif; background:var(--bg-app); color:var(--text-main); height:100vh; display:flex; flex-direction:column; overflow:hidden; }

        /* --- SETUP SCREEN (ONBOARDING) --- */
        #setup-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-card); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px; text-align:center; overflow-y:auto; }
        .setup-title { font-size:24px; font-weight:800; color:var(--primary); margin-bottom:10px; }
        .setup-step { width:100%; max-width:350px; text-align:left; margin-bottom:20px; }
        .setup-label { font-size:14px; font-weight:600; margin-bottom:8px; display:block; color:var(--text-sub); }
        .setup-input { width:100%; padding:15px; border-radius:12px; border:2px solid var(--border); background:var(--bg-app); color:var(--text-main); font-size:16px; outline:none; transition:0.3s; }
        .setup-input:focus { border-color:var(--primary); }
        
        /* Avatar & Gender Selector */
        .grid-select { display:flex; gap:10px; overflow-x:auto; padding-bottom:5px; }
        .choice-card { border:2px solid var(--border); border-radius:12px; padding:10px; cursor:pointer; min-width:80px; text-align:center; transition:0.2s; opacity:0.6; }
        .choice-card.selected { border-color:var(--primary); background:rgba(37,99,235,0.1); opacity:1; transform:scale(1.05); }
        .choice-icon { font-size:24px; margin-bottom:5px; display:block; }
        
        .btn-start { background:var(--primary); color:white; width:100%; padding:15px; border-radius:15px; border:none; font-weight:bold; font-size:16px; margin-top:20px; box-shadow:0 5px 15px rgba(37,99,235,0.3); }

        /* --- MAIN APP --- */
        #app-container { display:none; flex-direction:column; height:100%; }
        
        /* HEADER */
        header { padding:20px 20px 10px; background:var(--bg-app); display:flex; justify-content:space-between; align-items:center; }
        .head-title { font-size:24px; font-weight:800; }
        .status-badge { font-size:12px; background:rgba(16,185,129,0.1); color:#10b981; padding:4px 10px; border-radius:20px; display:flex; align-items:center; gap:5px; font-weight:600; }
        .pulse { width:8px; height:8px; background:#10b981; border-radius:50%; animation:ping 1.5s infinite; }
        @keyframes ping { 0%{box-shadow:0 0 0 0 rgba(16,185,129,0.7);} 70%{box-shadow:0 0 0 5px rgba(16,185,129,0);} 100%{box-shadow:0 0 0 0 rgba(16,185,129,0);} }

        /* PAGES */
        #pages { flex:1; position:relative; overflow:hidden; }
        .page { position:absolute; top:0; left:0; width:100%; height:100%; overflow-y:auto; display:none; padding-bottom:80px; }
        .page.active { display:block; animation:fadeUp 0.3s; }
        @keyframes fadeUp { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* LIST ITEMS */
        .list-item { padding:15px 20px; background:var(--bg-card); margin-bottom:1px; display:flex; align-items:center; cursor:pointer; }
        .avatar-circle { width:45px; height:45px; background:#e0f2fe; color:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px; margin-right:15px; position:relative; }
        .online-dot { position:absolute; bottom:0; right:0; width:12px; height:12px; background:#10b981; border:2px solid var(--bg-card); border-radius:50%; }
        
        /* RADAR */
        .radar-box { text-align:center; padding:40px 20px; }
        .radar-circle { width:80px; height:80px; background:rgba(37,99,235,0.1); border-radius:50%; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; color:var(--primary); font-size:30px; }

        /* PROFILE */
        .profile-card { background:var(--bg-card); margin:20px; padding:30px; border-radius:20px; text-align:center; border:1px solid var(--border); }
        .my-avatar { width:90px; height:90px; background:#f3f4f6; border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:40px; color:#333; }
        
        /* BOTTOM NAV */
        .nav { position:fixed; bottom:20px; left:20px; right:20px; background:var(--nav-bg); padding:15px; border-radius:20px; display:flex; justify-content:space-around; box-shadow:0 10px 30px rgba(0,0,0,0.1); z-index:50; }
        .nav-item { text-align:center; color:var(--text-sub); font-size:10px; font-weight:600; opacity:0.7; transition:0.2s; }
        .nav-item.active { color:var(--primary); opacity:1; transform:translateY(-2px); }
        .nav-icon { font-size:20px; margin-bottom:5px; display:block; }

        /* CHAT ROOM */
        #chat-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-app); z-index:100; display:none; flex-direction:column; }
        .chat-head { padding:15px; background:var(--bg-card); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; }
        #msgs { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px; }
        .bubble { max-width:75%; padding:10px 15px; border-radius:15px; font-size:14px; word-wrap:break-word; }
        .me { align-self:flex-end; background:var(--me-bubble); color:var(--me-text); border-bottom-right-radius:2px; }
        .other { align-self:flex-start; background:var(--bg-card); border:1px solid var(--border); border-bottom-left-radius:2px; }
        .input-bar { padding:10px; background:var(--bg-card); display:flex; gap:10px; border-top:1px solid var(--border); }
        .input-bar input { flex:1; padding:10px 15px; border-radius:20px; border:1px solid var(--border); background:var(--bg-app); color:var(--text-main); outline:none; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <div class="setup-title">Setup Profil</div>
        <p style="color:gray; margin-bottom:30px;">Buat identitas Mesh-mu agar dikenali teman.</p>
        
        <div class="setup-step">
            <label class="setup-label">Username / Nama Panggilan</label>
            <input type="text" id="setup-name" class="setup-input" placeholder="Contoh: Agent 007">
        </div>

        <div class="setup-step">
            <label class="setup-label">Gender</label>
            <div class="grid-select">
                <div class="choice-card" onclick="selGender('Laki', this)" id="g-laki">
                    <span class="choice-icon">ðŸ‘¨</span> Laki
                </div>
                <div class="choice-card" onclick="selGender('Perempuan', this)" id="g-pr">
                    <span class="choice-icon">ðŸ‘©</span> Pr
                </div>
            </div>
        </div>

        <div class="setup-step">
            <label class="setup-label">Pilih Avatar</label>
            <div class="grid-select">
                <div class="choice-card" onclick="selAvatar('robot', this)"><span class="choice-icon">ðŸ¤–</span></div>
                <div class="choice-card" onclick="selAvatar('alien', this)"><span class="choice-icon">ðŸ‘½</span></div>
                <div class="choice-card" onclick="selAvatar('ninja', this)"><span class="choice-icon">ðŸ¥·</span></div>
                <div class="choice-card" onclick="selAvatar('ghost', this)"><span class="choice-icon">ðŸ‘»</span></div>
                <div class="choice-card" onclick="selAvatar('cat', this)"><span class="choice-icon">ðŸ˜¼</span></div>
            </div>
        </div>

        <button class="btn-start" onclick="saveSetup()">MASUK MESH NETWORK</button>
    </div>

    <div id="app-container">
        <header>
            <div>
                <div class="head-title">Pesan</div>
                <div style="font-size:12px; color:gray;" id="my-identity">User</div>
            </div>
            <div class="status-badge"><div class="pulse"></div> BLE Aktif</div>
        </header>

        <div id="pages">
            <div id="p-radar" class="page active">
                <div class="radar-box">
                    <div class="radar-circle"><i class="fas fa-satellite-dish"></i></div>
                    <h3>Radar Sekitar</h3>
                    <p style="color:gray; font-size:13px;">Otomatis mendeteksi pengguna Mesh lain...</p>
                </div>
                <div style="padding:0 20px; font-weight:bold; margin-bottom:10px;">Ditemukan:</div>
                <div id="list-nearby"></div>
            </div>

            <div id="p-profile" class="page">
                <div class="profile-card">
                    <div class="my-avatar" id="prof-avatar">ðŸ¤–</div>
                    <h2 id="prof-name">User</h2>
                    <div style="font-size:12px; background:#eee; color:#333; padding:5px 10px; border-radius:10px; display:inline-block;" id="prof-gender">Gender</div>
                    <br><br>
                    <div style="font-family:monospace; color:gray;" id="prof-id">ID: MESH-XXX</div>
                </div>
                <div class="profile-card" style="text-align:left; padding:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span><i class="fas fa-moon"></i> Dark Mode</span>
                        <input type="checkbox" onclick="toggleTheme()" id="theme-tog">
                    </div>
                </div>
            </div>
        </div>

        <div class="nav">
            <div class="nav-item active" id="n-radar" onclick="nav('radar')">
                <i class="fas fa-radar nav-icon"></i> Radar
            </div>
            <div class="nav-item" id="n-profile" onclick="nav('profile')">
                <i class="fas fa-user-astronaut nav-icon"></i> Profil
            </div>
        </div>
    </div>

    <div id="chat-screen">
        <div class="chat-head">
            <i class="fas fa-arrow-left" onclick="closeChat()" style="font-size:20px;"></i>
            <b id="chat-title">User</b>
        </div>
        <div id="msgs"></div>
        <div class="input-bar">
            <input type="text" id="chat-input" placeholder="Ketik pesan...">
            <i class="fas fa-paper-plane" onclick="sendMsg()" style="font-size:24px; color:var(--primary); align-self:center;"></i>
        </div>
    </div>

    <script src="cordova.js"></script>
    <script>
        var ble;
        var MY_UUID = "180F"; // UUID Bajakan (Battery Service) biar kompatibel semua HP
        var user = { name:"", gender:"", avatar:"ðŸ¤–", id:"" };
        var activeAddr = "";

        document.addEventListener('deviceready', function() {
            ble = window.bluetoothle;
            checkLogin();
        }, false);

        // --- SETUP LOGIC ---
        var tempGender="", tempAvatar="ðŸ¤–";

        function selGender(g, el) {
            tempGender = g;
            document.querySelectorAll('#g-laki, #g-pr').forEach(x=>x.classList.remove('selected'));
            el.classList.add('selected');
        }
        function selAvatar(a, el) {
            var icons = {'robot':'ðŸ¤–','alien':'ðŸ‘½','ninja':'ðŸ¥·','ghost':'ðŸ‘»','cat':'ðŸ˜¼'};
            tempAvatar = icons[a];
            document.querySelectorAll('.choice-card').forEach(x=>x.classList.remove('selected'));
            el.classList.add('selected');
        }

        function saveSetup() {
            var n = document.getElementById('setup-name').value.trim();
            if(!n || !tempGender) return alert("Isi Nama & Pilih Gender dulu!");
            
            var id = "MESH-" + Math.floor(Math.random()*9999);
            var data = { name:n, gender:tempGender, avatar:tempAvatar, id:id };
            
            localStorage.setItem('mesh_user', JSON.stringify(data));
            checkLogin();
        }

        function checkLogin() {
            var saved = localStorage.getItem('mesh_user');
            if(saved) {
                user = JSON.parse(saved);
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                
                // Update UI Profil
                document.getElementById('my-identity').innerText = user.name;
                document.getElementById('prof-name').innerText = user.name;
                document.getElementById('prof-avatar').innerText = user.avatar;
                document.getElementById('prof-gender').innerText = user.gender;
                document.getElementById('prof-id').innerText = user.id;

                initBLE();
            }
        }

        // --- BLE LOGIC (AUTO DETECT) ---
        function initBLE() {
            // Izin
            var p = cordova.plugins.permissions;
            p.requestPermissions([
                p.ACCESS_FINE_LOCATION, p.BLUETOOTH_SCAN, p.BLUETOOTH_ADVERTISE, p.BLUETOOTH_CONNECT
            ], function(){
                startBLESystem();
            }, function(){});
        }

        function startBLESystem() {
            ble.initialize(function(s){ 
                if(s.status === 'enabled') {
                    startAdvertising();
                    startScanning();
                }
            });
        }

        function startAdvertising() {
            // Kita pancarkan Nama User kita
            ble.initializePeripheral({ request:true }, function(res){
                if(res.status==='enabled') {
                    ble.addService({
                        service: MY_UUID,
                        characteristics: [{ uuid:"2A19", permissions:{read:true,write:true}, properties:{read:true,write:true,notify:true} }]
                    }, function(){
                        ble.startAdvertising({ services:[MY_UUID], service:MY_UUID, name:user.name }, 
                        function(){ console.log("Broadcasting " + user.name); }, function(){});
                    }, function(){});
                }
            }, function(){});
        }

        function startScanning() {
            ble.startScan({ services:[MY_UUID] }, function(res){
                if(res.status === 'scanResult') {
                    renderDevice(res);
                }
            }, function(e){ console.log(e); });
        }

        var found = {};
        function renderDevice(d) {
            if(found[d.address]) return;
            found[d.address] = d;
            
            var name = d.name || "Unknown Mesh";
            var el = document.getElementById('list-nearby');
            
            var html = `<div class="list-item" onclick="openChat('${d.address}','${name}')">
                <div class="avatar-circle"><i class="fas fa-user"></i><div class="online-dot"></div></div>
                <div><div style="font-weight:bold;">${name}</div><div style="font-size:11px; color:gray;">Tap untuk chat</div></div>
            </div>`;
            el.innerHTML += html;
        }

        // --- CHAT LOGIC ---
        function openChat(addr, name) {
            activeAddr = addr;
            document.getElementById('chat-screen').style.display='flex';
            document.getElementById('chat-title').innerText = name;
            
            ble.connect({ address:addr }, function(r){
                if(r.status === 'connected') {
                    // Subscribe pesan masuk
                    ble.subscribe({ address:addr, service:MY_UUID, characteristic:"2A19" }, function(data){
                        if(data.value) {
                            var txt = atob(data.value);
                            addBubble(txt, 'other');
                        }
                    }, function(){});
                }
            }, function(){ alert("Gagal konek, coba lagi."); });
        }

        function sendMsg() {
            var t = document.getElementById('chat-input').value;
            if(!t) return;
            var b64 = btoa(t);
            ble.write({ address:activeAddr, service:MY_UUID, characteristic:"2A19", value:b64, type:"noResponse" }, function(){
                addBubble(t, 'me');
                document.getElementById('chat-input').value="";
            }, function(){ alert("Gagal kirim"); });
        }

        function addBubble(t, who) {
            var d = document.createElement('div'); d.className="bubble "+who; d.innerText=t;
            document.getElementById('msgs').appendChild(d);
        }

        function closeChat() {
            document.getElementById('chat-screen').style.display='none';
            if(activeAddr) ble.disconnect({address:activeAddr});
        }

        // --- UI UTILS ---
        function nav(p) {
            document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            document.getElementById('p-'+p).classList.add('active');
            document.getElementById('n-'+p).classList.add('active');
        }

        function toggleTheme() {
            if(document.body.getAttribute('data-theme')==='dark') document.body.removeAttribute('data-theme');
            else document.body.setAttribute('data-theme','dark');
        }
    </script>
</body>
</html>
