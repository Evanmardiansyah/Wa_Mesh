<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval';">
    <title>Mesh BLE</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { margin:0; font-family:'Inter',sans-serif; background:#f0f2f5; display:flex; flex-direction:column; height:100vh; }
        header { background:#2563eb; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
        .radar-box { background:white; margin:10px; padding:15px; border-radius:12px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
        .radar-anim { width:10px; height:10px; background:#10b981; border-radius:50%; display:inline-block; animation:blink 1s infinite; margin-right:5px; }
        @keyframes blink { 0%{opacity:1} 50%{opacity:0.3} 100%{opacity:1} }
        
        #device-list { flex:1; overflow-y:auto; padding:10px; }
        .item { background:white; padding:15px; border-radius:10px; margin-bottom:10px; display:flex; align-items:center; cursor:pointer; border:1px solid #ddd; }
        .avatar { width:40px; height:40px; background:#e0f2fe; color:#2563eb; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-right:15px; font-weight:bold; }
        
        #chat-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:100; display:none; flex-direction:column; }
        #msgs { flex:1; overflow-y:auto; padding:15px; background:#f0f2f5; }
        .bubble { max-width:80%; padding:10px 15px; border-radius:15px; margin-bottom:10px; font-size:14px; word-wrap:break-word; }
        .me { align-self:flex-end; background:#2563eb; color:white; margin-left:auto; }
        .other { align-self:flex-start; background:white; border:1px solid #ddd; }
        .input-area { padding:10px; border-top:1px solid #ddd; display:flex; gap:10px; }
        input { flex:1; padding:10px; border-radius:20px; border:1px solid #ddd; }
        button { background:#2563eb; color:white; border:none; padding:10px 20px; border-radius:20px; }
    </style>
</head>
<body>

    <header>
        <b>Nusa Mesh KW (BLE)</b>
        <div style="font-size:12px; opacity:0.8;">v3.0</div>
    </header>

    <div class="radar-box">
        <div id="status"><span class="radar-anim"></span> Radar Aktif</div>
        <div style="font-size:11px; color:gray; margin-top:5px;">Nama Kamu: <b id="my-name">User</b></div>
    </div>

    <div id="device-list">
        <div style="text-align:center; color:gray; padding:20px;">Scanning...</div>
    </div>

    <div id="chat-screen">
        <header>
            <i class="fas fa-arrow-left" onclick="closeChat()"></i>
            <span id="chat-target">User</span>
            <div></div>
        </header>
        <div id="msgs"></div>
        <div class="input-area">
            <input type="text" id="inp" placeholder="Pesan...">
            <button onclick="send()">Kirim</button>
        </div>
    </div>

    <script src="cordova.js"></script>
    <script>
        var ble;
        var MY_UUID = "180F"; // Kita bajak UUID Battery Service biar gampang kedetect
        var activeAddr = "";

        document.addEventListener('deviceready', function() {
            ble = window.bluetoothle;
            
            // Generate Random Name
            var myName = "User " + Math.floor(Math.random()*999);
            document.getElementById('my-name').innerText = myName;

            // 1. INIT
            ble.initialize(function(status) {
                if(status.status === "enabled") {
                    startSystem(myName);
                }
            });

            // Izin Lokasi Wajib
            var p = cordova.plugins.permissions;
            p.requestPermissions([
                p.ACCESS_FINE_LOCATION, 
                p.BLUETOOTH_SCAN, 
                p.BLUETOOTH_CONNECT,
                p.BLUETOOTH_ADVERTISE
            ], function(){}, function(){});

        }, false);

        function startSystem(name) {
            // 2. JADI PEMANCAR (ADVERTISE)
            // Biar HP lain bisa lihat kita
            ble.initializePeripheral({
                request: true,
                restoreKey: "mesh_chat"
            }, function(res) {
                if(res.status === "enabled") {
                    ble.addService({
                        service: MY_UUID,
                        characteristics: [{
                            uuid: "2A19", // Bajak Characteristic Level
                            permissions: { read: true, write: true },
                            properties: { read: true, write: true, notify: true }
                        }]
                    }, function() {
                        ble.startAdvertising({
                            services: [MY_UUID],
                            service: MY_UUID,
                            name: name
                        }, function(){ console.log("Advertising..."); }, function(){});
                    }, function(){});
                }
            }, function(){});

            // 3. JADI RADAR (SCAN)
            // Cari HP lain
            startScan();
        }

        function startScan() {
            ble.startScan({ services: [MY_UUID] }, function(res) {
                if(res.status === "scanResult") {
                    addToList(res);
                }
            }, function(err) {
                document.getElementById('status').innerText = "Gagal Scan: " + JSON.stringify(err);
            });
        }

        var foundDevs = {};
        function addToList(dev) {
            if(foundDevs[dev.address]) return;
            foundDevs[dev.address] = dev;

            var name = dev.name || "Unknown";
            var html = `<div class="item" onclick="connect('${dev.address}', '${name}')">
                <div class="avatar"><i class="fas fa-user"></i></div>
                <div><b>${name}</b><br><span style="font-size:11px; color:gray;">${dev.address}</span></div>
            </div>`;
            document.getElementById('device-list').innerHTML += html;
        }

        function connect(addr, name) {
            activeAddr = addr;
            document.getElementById('chat-screen').style.display='flex';
            document.getElementById('chat-target').innerText = name;
            
            ble.connect({ address: addr }, function(res) {
                if(res.status === "connected") {
                    // Subscribe biar bisa terima pesan
                    ble.subscribe({
                        address: addr,
                        service: MY_UUID,
                        characteristic: "2A19"
                    }, function(data) {
                        if(data.value) {
                            var msg = atob(data.value); // Decode Base64
                            addMsg(msg, 'other');
                        }
                    }, function(){});
                }
            }, function(){ alert("Gagal Konek"); });
        }

        function send() {
            var txt = document.getElementById('inp').value;
            if(!txt) return;
            
            // Encode ke Base64 (Syarat BLE)
            var bytes = btoa(txt); 
            
            ble.write({
                address: activeAddr,
                service: MY_UUID,
                characteristic: "2A19",
                value: bytes,
                type: "noResponse"
            }, function() {
                addMsg(txt, 'me');
                document.getElementById('inp').value="";
            }, function(e){ alert("Gagal Kirim: "+JSON.stringify(e)); });
        }

        function addMsg(txt, who) {
            var d = document.createElement('div');
            d.className = "bubble " + who;
            d.innerText = txt;
            document.getElementById('msgs').appendChild(d);
        }

        function closeChat() {
            document.getElementById('chat-screen').style.display='none';
            if(activeAddr) ble.disconnect({address: activeAddr});
        }
    </script>
</body>
</html>
