<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval';">
    
    <title>Messenger Mesh</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2563eb; --bg-app: #f8f9fa; --bg-card: #ffffff; --text-main: #1f2937; --text-sub: #6b7280; --border: #e5e7eb; }
        [data-theme="dark"] { --primary: #60a5fa; --bg-app: #111827; --bg-card: #1f2937; --text-main: #f3f4f6; --text-sub: #9ca3af; --border: #374151; }
        body { margin:0; font-family:'Inter',sans-serif; background:var(--bg-app); color:var(--text-main); height:100vh; display:flex; flex-direction:column; overflow:hidden; }

        /* SETUP SCREEN */
        #setup-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-card); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px; text-align:center; }
        .setup-input { width:100%; padding:15px; border-radius:12px; border:2px solid var(--border); background:var(--bg-app); color:var(--text-main); margin-bottom:15px; text-align:center; font-size:16px; }
        .grid-select { display:flex; gap:10px; margin-bottom:20px; }
        .choice-card { border:2px solid var(--border); padding:10px; border-radius:10px; font-size:24px; cursor:pointer; opacity:0.5; }
        .choice-card.selected { border-color:var(--primary); opacity:1; background:rgba(37,99,235,0.1); }
        .btn-start { background:var(--primary); color:white; width:100%; padding:15px; border-radius:15px; border:none; font-weight:bold; font-size:16px; }

        /* HEADER & RADAR STATUS */
        header { padding:20px; background:var(--bg-app); display:flex; justify-content:space-between; align-items:center; }
        .head-title { font-size:24px; font-weight:800; }
        .status-badge { font-size:12px; padding:5px 10px; border-radius:20px; background:rgba(16,185,129,0.1); color:#10b981; font-weight:bold; display:flex; align-items:center; gap:5px; }
        .pulse { width:8px; height:8px; background:#10b981; border-radius:50%; animation:ping 1.5s infinite; }
        @keyframes ping { 0%{box-shadow:0 0 0 0 rgba(16,185,129,0.7);} 100%{box-shadow:0 0 0 10px rgba(16,185,129,0);} }

        /* MAIN CONTENT */
        #app-container { display:none; flex-direction:column; height:100%; }
        #list-nearby { flex:1; overflow-y:auto; padding:0 20px 80px 20px; }
        
        .list-item { padding:15px; background:var(--bg-card); margin-bottom:10px; border-radius:15px; display:flex; align-items:center; border:1px solid var(--border); cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
        .avatar-box { width:50px; height:50px; background:#e0f2fe; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px; margin-right:15px; }
        
        /* CHAT ROOM */
        #chat-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-app); z-index:100; display:none; flex-direction:column; }
        .chat-head { padding:15px; background:var(--bg-card); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; font-weight:bold; }
        #msgs { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px; }
        .bubble { max-width:80%; padding:12px 16px; border-radius:15px; font-size:14px; }
        .me { align-self:flex-end; background:var(--primary); color:white; border-bottom-right-radius:2px; }
        .other { align-self:flex-start; background:var(--bg-card); border:1px solid var(--border); border-bottom-left-radius:2px; }
        .input-bar { padding:10px; background:var(--bg-card); display:flex; gap:10px; border-top:1px solid var(--border); }
        .input-bar input { flex:1; padding:12px; border-radius:25px; border:1px solid var(--border); background:var(--bg-app); outline:none; color:var(--text-main); }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h2 style="color:var(--primary);">Messenger Mesh</h2>
        <p style="color:var(--text-sub); margin-bottom:20px;">Jaringan BitChat Lokal</p>
        
        <input type="text" id="setup-name" class="setup-input" placeholder="Nama Kamu">
        
        <div class="grid-select">
            <div class="choice-card" onclick="selAvatar('ü§ñ', this)">ü§ñ</div>
            <div class="choice-card" onclick="selAvatar('üëΩ', this)">üëΩ</div>
            <div class="choice-card" onclick="selAvatar('ü•∑', this)">ü•∑</div>
            <div class="choice-card" onclick="selAvatar('ü¶Å', this)">ü¶Å</div>
        </div>

        <button class="btn-start" onclick="saveSetup()">GABUNG NETWORK</button>
        <div style="margin-top:20px; font-size:10px; color:gray;" id="debug-log">Menunggu Izin...</div>
    </div>

    <div id="app-container">
        <header>
            <div>
                <div class="head-title">Radar</div>
                <div style="font-size:12px; color:var(--text-sub);" id="my-info">User</div>
            </div>
            <div class="status-badge" onclick="restartEngine()"><div class="pulse"></div> SCANNING</div>
        </header>

        <div id="list-nearby">
            <div style="text-align:center; padding:50px; color:var(--text-sub);">
                <i class="fas fa-satellite-dish" style="font-size:40px; margin-bottom:10px; opacity:0.5;"></i><br>
                Mencari perangkat BitChat...<br>
                <small>(Pastikan teman juga membuka aplikasi ini)</small>
            </div>
        </div>
    </div>

    <div id="chat-screen">
        <div class="chat-head">
            <i class="fas fa-arrow-left" onclick="closeChat()"></i>
            <span id="chat-target">User</span>
        </div>
        <div id="msgs"></div>
        <div class="input-bar">
            <input type="text" id="chat-inp" placeholder="Pesan...">
            <i class="fas fa-paper-plane" style="font-size:20px; color:var(--primary); align-self:center;" onclick="sendMsg()"></i>
        </div>
    </div>

    <script src="cordova.js"></script>
    <script>
        var ble;
        // --- RAHASIA BITCHAT: UUID 128-BIT (Bukan 180F) ---
        // Kita pakai UUID acak yang "bersih" agar tidak diblokir Android
        var SERVICE_UUID = "6E400001-B5A3-F393-E0A9-E50E24DCCA9E"; 
        var CHAR_UUID    = "6E400002-B5A3-F393-E0A9-E50E24DCCA9E"; 
        
        var user = { name:"", avatar:"ü§ñ", id:"" };
        var activeAddr = "";
        var tempAvatar = "ü§ñ";

        document.addEventListener('deviceready', function() {
            ble = window.bluetoothle;
            log("System Ready. Checking permissions...");
            checkLogin();
        }, false);

        // --- SETUP ---
        function selAvatar(a, el) { tempAvatar=a; document.querySelectorAll('.choice-card').forEach(x=>x.classList.remove('selected')); el.classList.add('selected'); }
        
        function saveSetup() {
            var n = document.getElementById('setup-name').value.trim();
            if(!n) return alert("Isi nama dulu!");
            var id = "ID-" + Math.floor(Math.random()*10000);
            localStorage.setItem('mesh_user_v2', JSON.stringify({ name:n, avatar:tempAvatar, id:id }));
            checkLogin();
        }

        function checkLogin() {
            var s = localStorage.getItem('mesh_user_v2');
            if(s) {
                user = JSON.parse(s);
                document.getElementById('setup-screen').style.display='none';
                document.getElementById('app-container').style.display='flex';
                document.getElementById('my-info').innerText = user.avatar + " " + user.name;
                initBLE();
            }
        }

        // --- BLE ENGINE (BITCHAT METHOD) ---
        function initBLE() {
            var p = cordova.plugins.permissions;
            var list = [
                p.ACCESS_FINE_LOCATION, 
                p.BLUETOOTH_SCAN, 
                p.BLUETOOTH_ADVERTISE, 
                p.BLUETOOTH_CONNECT
            ];

            p.requestPermissions(list, function(status) {
                if(!status.hasPermission) log("WARN: Sebagian izin ditolak Android.");
                startEngine();
            }, function() { log("ERR: Izin Ditolak Total"); });
        }

        function startEngine() {
            ble.initialize(function(status) {
                if(status.status === 'enabled') {
                    log("Bluetooth ON. Starting Mesh...");
                    startAdvertising(); // Biar kita KELIHATAN
                    startScanning();    // Biar kita MELIHAT
                } else {
                    log("Bluetooth OFF! Nyalakan dulu.");
                }
            }, { request: true, statusReceiver: false });
        }

        function log(msg) {
            console.log(msg);
            document.getElementById('debug-log').innerText = msg;
        }

        // 1. ADVERTISING (MEMANCARKAN SINYAL)
        function startAdvertising() {
            var params = {
                services: [SERVICE_UUID],
                service: SERVICE_UUID,
                name: user.name, // Nama HP kita jadi nama User
                mode: "lowLatency", // Mode Agresif biar cepat kedetect
                connectable: true,
                timeout: 0 // Iklan terus tanpa henti
            };

            ble.initializePeripheral({ request: true }, function(res) {
                if(res.status === 'enabled') {
                    // Buat Service
                    ble.addService({
                        service: SERVICE_UUID,
                        characteristics: [{ 
                            uuid: CHAR_UUID, 
                            permissions: { read: true, write: true }, 
                            properties: { read: true, write: true, notify: true } 
                        }]
                    }, function() {
                        // Mulai Iklan
                        ble.startAdvertising(params, 
                            function() { log("Broadcasting OK: " + user.name); },
                            function(e) { log("Broadcast Fail: " + JSON.stringify(e)); }
                        );
                    }, function(e) { log("Add Service Fail: " + JSON.stringify(e)); });
                }
            }, function(e) { log("Init Peripheral Fail: " + JSON.stringify(e)); });
        }

        // 2. SCANNING (MENCARI SINYAL)
        function startScanning() {
            // Scan hanya UUID kita (Filter BitChat)
            ble.startScan({ services: [SERVICE_UUID], scanMode: "lowLatency" }, 
            function(res) {
                if(res.status === 'scanResult') {
                    renderDevice(res);
                }
            }, function(e) { log("Scan Error: " + JSON.stringify(e)); });
        }

        var foundDevices = {};
        function renderDevice(dev) {
            if(foundDevices[dev.address]) return;
            foundDevices[dev.address] = dev;

            var name = dev.name || "Unknown User";
            var rssi = dev.rssi; // Kekuatan sinyal
            
            // Render UI
            var el = document.getElementById('list-nearby');
            if(Object.keys(foundDevices).length === 1) el.innerHTML = ""; // Hapus loading
            
            var html = `
            <div class="list-item" onclick="openChat('${dev.address}', '${name}')">
                <div class="avatar-box"><i class="fas fa-user"></i></div>
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:16px;">${name}</div>
                    <div style="font-size:12px; color:gray;">Sinyal: ${rssi} dBm</div>
                </div>
                <div style="background:#e0f2fe; color:#2563eb; padding:5px 10px; border-radius:10px; font-size:12px;">Chat</div>
            </div>`;
            el.innerHTML += html;
        }

        function restartEngine() {
            log("Restarting Radar...");
            ble.stopScan(function(){ startScanning(); }, function(){});
        }

        // --- CHAT LOGIC ---
        function openChat(addr, name) {
            activeAddr = addr;
            document.getElementById('chat-screen').style.display='flex';
            document.getElementById('chat-target').innerText = name;
            
            ble.connect({ address: addr }, function(res) {
                if(res.status === 'connected') {
                    ble.subscribe({ address: addr, service: SERVICE_UUID, characteristic: CHAR_UUID }, function(data) {
                        if(data.value) {
                            var msg = atob(data.value);
                            addBubble(msg, 'other');
                        }
                    });
                }
            }, function() { alert("Gagal konek / Putus"); });
        }

        function sendMsg() {
            var t = document.getElementById('chat-inp').value;
            if(!t) return;
            var b64 = btoa(t);
            ble.write({ 
                address: activeAddr, 
                service: SERVICE_UUID, 
                characteristic: CHAR_UUID, 
                value: b64, 
                type: "noResponse" 
            }, function() {
                addBubble(t, 'me');
                document.getElementById('chat-inp').value="";
            });
        }

        function addBubble(t, w) {
            var d = document.createElement('div'); d.className="bubble "+w; d.innerText=t;
            document.getElementById('msgs').appendChild(d);
        }
        function closeChat() {
            document.getElementById('chat-screen').style.display='none';
            if(activeAddr) ble.disconnect({ address: activeAddr });
        }
    </script>
</body>
</html>
