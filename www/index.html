<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval';">
    
    <title>BitChat Mesh</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- MATERIAL DESIGN 3 THEME --- */
        :root {
            --md-primary: #006C4C;
            --md-on-primary: #FFFFFF;
            --md-primary-container: #89F8C7;
            --md-bg: #FBFDF9;
            --md-surface: #EBF2ED;
            --md-surface-variant: #DBE5DE;
            --md-outline: #707974;
            --md-text: #191C1B;
            --radius-L: 24px;
            --radius-M: 16px;
            --radius-S: 12px;
        }

        [data-theme="dark"] {
            --md-primary: #6CDDAE;
            --md-on-primary: #003826;
            --md-primary-container: #005138;
            --md-bg: #191C1B;
            --md-surface: #202523;
            --md-surface-variant: #404944;
            --md-outline: #89938D;
            --md-text: #E1E3DF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background: var(--md-bg);
            color: var(--md-text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            overflow: hidden;
        }

        /* --- TYPOGRAPHY --- */
        h1, h2, h3 { margin: 0; font-weight: 500; }
        .label-large { font-size: 14px; font-weight: 500; letter-spacing: 0.1px; }
        .body-medium { font-size: 14px; letter-spacing: 0.25px; }

        /* --- COMPONENTS --- */
        .btn-filled {
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            padding: 0 24px;
            height: 48px;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            transition: 0.2s;
        }
        .btn-filled:active { transform: scale(0.98); box-shadow: none; }

        .btn-tonal {
            background: var(--md-surface-variant);
            color: var(--md-text);
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 500;
        }

        .card {
            background: var(--md-surface);
            border-radius: var(--radius-M);
            padding: 16px;
            margin-bottom: 12px;
            display: flex; align-items: center; gap: 16px;
            transition: 0.2s;
        }
        .card:active { background: var(--md-surface-variant); }

        .avatar {
            width: 48px; height: 48px;
            border-radius: 50%;
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        /* --- SETUP SCREEN --- */
        #setup-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--md-bg); z-index: 999;
            display: flex; flex-direction: column;
            padding: 30px;
            overflow-y: auto;
        }
        .input-box {
            background: var(--md-surface-variant);
            border: none; border-bottom: 2px solid var(--md-outline);
            padding: 16px;
            font-size: 16px;
            color: var(--md-text);
            border-radius: 4px 4px 0 0;
            outline: none; width: 100%;
            margin-bottom: 24px;
        }
        .input-box:focus { border-color: var(--md-primary); background: rgba(0,0,0,0.05); }
        
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 30px; }
        .grid-item {
            aspect-ratio: 1;
            border-radius: var(--radius-S);
            border: 1px solid var(--md-outline);
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; cursor: pointer;
        }
        .grid-item.selected {
            background: var(--md-primary-container);
            border-color: var(--md-primary);
            border-width: 2px;
        }

        /* --- MAIN APP --- */
        #app-view { display: none; flex-direction: column; height: 100%; }

        header {
            padding: 16px 24px;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--md-bg);
        }
        .status-chip {
            font-size: 12px;
            padding: 6px 16px;
            border-radius: 20px;
            background: var(--md-primary-container);
            color: #002114;
            font-weight: 500;
            display: flex; align-items: center; gap: 6px;
        }
        .radar-ping { width: 8px; height: 8px; background: #006C4C; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(2.5); } }

        #content-area { flex: 1; overflow-y: auto; padding: 16px; }

        /* --- BOTTOM NAV --- */
        .bottom-bar {
            background: var(--md-surface);
            padding: 12px 0;
            display: flex; justify-content: space-around;
            border-top: 1px solid var(--md-outline);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: var(--md-outline); width: 64px;
        }
        .nav-icon-box {
            width: 64px; height: 32px;
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        .nav-item.active .nav-icon-box { background: var(--md-primary-container); color: #002114; }
        .nav-item.active { color: var(--md-text); font-weight: 600; }

        /* --- CHAT ROOM --- */
        #chat-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--md-bg); z-index: 100;
            display: none; flex-direction: column;
        }
        .chat-appbar {
            padding: 12px 16px; display: flex; align-items: center; gap: 16px;
            background: var(--md-surface); elevation: 2;
        }
        #msgs-list { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
        
        .bubble {
            max-width: 80%; padding: 12px 16px;
            border-radius: 16px; font-size: 15px; line-height: 1.4;
        }
        .me { align-self: flex-end; background: var(--md-primary); color: var(--md-on-primary); border-bottom-right-radius: 4px; }
        .other { align-self: flex-start; background: var(--md-surface-variant); color: var(--md-text); border-bottom-left-radius: 4px; }
        
        .input-area {
            padding: 12px 16px; background: var(--md-surface);
            display: flex; gap: 12px; align-items: center;
        }
        .msg-input {
            flex: 1; padding: 12px 20px; border-radius: 24px;
            border: none; background: var(--md-surface-variant);
            color: var(--md-text); outline: none; font-size: 16px;
        }
    </style>
</head>
<body>

    <div id="setup-view">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <span class="material-icons-round" style="font-size:64px; color:var(--md-primary); margin-bottom:24px;">leak_add</span>
            <h1 style="margin-bottom:8px;">BitChat Mesh</h1>
            <p class="body-medium" style="color:var(--md-outline); margin-bottom:40px;">Komunikasi P2P Tanpa Internet</p>
            
            <input type="text" id="in-name" class="input-box" placeholder="Nama Kode / Agen">
            
            <p class="label-large" style="margin-bottom:12px;">Pilih Identitas</p>
            <div class="grid-4">
                <div class="grid-item" onclick="pick('ü§ñ',this)">ü§ñ</div>
                <div class="grid-item" onclick="pick('ü¶ä',this)">ü¶ä</div>
                <div class="grid-item" onclick="pick('üëΩ',this)">üëΩ</div>
                <div class="grid-item" onclick="pick('ü¶Å',this)">ü¶Å</div>
            </div>
        </div>
        
        <button class="btn-filled" onclick="finishSetup()">
            <span class="material-icons-round">radar</span>
            AKTIFKAN RADAR
        </button>
        <div id="perm-log" style="text-align:center; font-size:11px; margin-top:10px; color:gray;">System Check...</div>
    </div>

    <div id="app-view">
        <header>
            <div>
                <h2 style="font-size:22px;">Radar</h2>
                <div class="body-medium" id="my-id-disp" style="color:var(--md-outline)">User</div>
            </div>
            <div class="status-chip" onclick="engine.restart()">
                <div class="radar-ping"></div> Live
            </div>
        </header>

        <div id="content-area">
            <div style="text-align:center; padding-top:100px; opacity:0.5;">
                <span class="material-icons-round" style="font-size:48px; color:var(--md-outline);">wifi_tethering</span>
                <p>Mencari sinyal di sekitar...</p>
            </div>
        </div>

        <div class="bottom-bar">
            <div class="nav-item active">
                <div class="nav-icon-box"><span class="material-icons-round">radar</span></div>
                <span style="font-size:12px;">Sekitar</span>
            </div>
            <div class="nav-item" onclick="toggleTheme()">
                <div class="nav-icon-box"><span class="material-icons-round">dark_mode</span></div>
                <span style="font-size:12px;">Tema</span>
            </div>
        </div>
    </div>

    <div id="chat-view">
        <div class="chat-appbar">
            <span class="material-icons-round" onclick="closeChat()">arrow_back</span>
            <div class="avatar" id="chat-av" style="width:40px; height:40px; font-size:20px;">?</div>
            <div style="flex:1;">
                <div class="label-large" id="chat-name" style="font-size:16px;">User</div>
                <div style="font-size:12px; color:var(--md-primary);">‚óè Connected</div>
            </div>
        </div>
        <div id="msgs-list"></div>
        <div class="input-area">
            <input type="text" id="msg-in" class="msg-input" placeholder="Pesan...">
            <span class="material-icons-round" style="color:var(--md-primary); padding:10px;" onclick="sendMsg()">send</span>
        </div>
    </div>

    <script src="cordova.js"></script>
    <script>
        // --- CONFIG MESIN ---
        // UUID Khusus (128-bit) agar tidak bentrok
        const APP_UUID = "6E400001-B5A3-F393-E0A9-E50E24DCCA9E"; 
        const CHAR_UUID = "6E400002-B5A3-F393-E0A9-E50E24DCCA9E";

        let user = { name: "", avatar: "ü§ñ", id: "" };
        let devices = {};
        let activeAddr = null;
        let ble = null;

        document.addEventListener('deviceready', () => {
            ble = window.bluetoothle;
            checkSession();
        }, false);

        // --- SETUP UI ---
        let tempAv = "ü§ñ";
        function pick(a, el) {
            tempAv = a;
            document.querySelectorAll('.grid-item').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
        }

        function finishSetup() {
            let n = document.getElementById('in-name').value.trim();
            if (!n) return alert("Nama wajib diisi!");
            
            user = { 
                name: n, 
                avatar: tempAv, 
                id: Math.floor(Math.random() * 9999).toString() 
            };
            localStorage.setItem('bc_user', JSON.stringify(user));
            checkSession();
        }

        function checkSession() {
            let s = localStorage.getItem('bc_user');
            if (s) {
                user = JSON.parse(s);
                document.getElementById('setup-view').style.display = 'none';
                document.getElementById('app-view').style.display = 'flex';
                document.getElementById('my-id-disp').innerText = `${user.avatar} ${user.name}`;
                engine.init();
            }
        }

        // --- CORE ENGINE (THE FIX) ---
        const engine = {
            init: () => {
                const p = cordova.plugins.permissions;
                const perms = [
                    p.ACCESS_FINE_LOCATION,
                    p.BLUETOOTH_SCAN,
                    p.BLUETOOTH_ADVERTISE,
                    p.BLUETOOTH_CONNECT
                ];
                
                document.getElementById('perm-log').innerText = "Meminta Izin Android...";
                
                p.requestPermissions(perms, (status) => {
                    if(!status.hasPermission) alert("Izin Bluetooth Ditolak! Aplikasi tidak akan jalan.");
                    engine.start();
                }, () => alert("Error Izin"));
            },

            start: () => {
                ble.initialize((res) => {
                    if (res.status === 'enabled') {
                        engine.advertise(); // Pancarkan Sinyal
                        engine.scan();      // Cari Sinyal
                    } else {
                        alert("Bluetooth Mati. Nyalakan dulu!");
                    }
                }, { request: true, statusReceiver: false });
            },

            // LOGIC UTAMA: SPLIT PAYLOAD
            advertise: () => {
                // 1. Buat Service
                ble.initializePeripheral({ request: true }, (res) => {
                    if(res.status === 'enabled') {
                        ble.addService({
                            service: APP_UUID,
                            characteristics: [{ 
                                uuid: CHAR_UUID, 
                                permissions: { read: true, write: true }, 
                                properties: { read: true, write: true, notify: true } 
                            }]
                        }, () => {
                            // 2. Start Advertising (HANYA KIRIM NAMA, UUID OTOMATIS DI HANDLE)
                            // "mode: lowLatency" adalah kunci agar cepat terdeteksi
                            ble.startAdvertising({
                                services: [APP_UUID], 
                                service: APP_UUID, 
                                name: user.name, 
                                mode: "lowLatency",
                                connectable: true,
                                txPowerLevel: "high", 
                                includeDeviceName: true // INI KUNCINYA: Nama dikirim di Scan Response
                            }, 
                            () => console.log("Broadcasting OK"), 
                            (e) => console.log("Broadcast Fail", e));
                        }, (e) => console.log("Add Service Fail", e));
                    }
                }, (e) => console.log("Init Peri Fail", e));
            },

            scan: () => {
                // Scan Mode Agresif
                ble.startScan({ 
                    services: [APP_UUID], 
                    scanMode: "lowLatency",
                    matchMode: "aggressive" 
                }, (res) => {
                    if (res.status === 'scanResult') engine.render(res);
                }, (e) => console.log("Scan Error", e));
            },

            restart: () => {
                devices = {}; // Clear list visual
                document.getElementById('content-area').innerHTML = '<div style="text-align:center; padding:50px;">Rescanning...</div>';
                ble.stopScan(() => engine.scan(), () => engine.scan());
            },

            render: (dev) => {
                if (devices[dev.address]) return;
                devices[dev.address] = dev;

                // Jika nama kosong (kadang Android nge-lag), pakai ID
                let name = dev.name || "Unknown Signal";
                let rssi = dev.rssi;
                
                // Clear loading msg
                let area = document.getElementById('content-area');
                if(area.innerHTML.includes("Mencari")) area.innerHTML = "";

                let html = `
                <div class="card" onclick="chat.open('${dev.address}', '${name}')">
                    <div class="avatar"><span class="material-icons-round">person</span></div>
                    <div style="flex:1;">
                        <div class="label-large" style="font-size:16px;">${name}</div>
                        <div class="body-medium" style="color:var(--md-outline); font-size:12px;">
                            Sinyal: ${rssi} dBm
                        </div>
                    </div>
                    <span class="material-icons-round" style="color:var(--md-primary);">chat</span>
                </div>`;
                area.innerHTML += html;
            }
        };

        // --- CHAT LOGIC ---
        const chat = {
            open: (addr, name) => {
                activeAddr = addr;
                document.getElementById('chat-view').style.display = 'flex';
                document.getElementById('chat-name').innerText = name;
                document.getElementById('msgs-list').innerHTML = "";
                
                ble.connect({ address: addr }, (res) => {
                    if(res.status === 'connected') {
                        // Subscribe
                        ble.subscribe({ address: addr, service: APP_UUID, characteristic: CHAR_UUID }, (data) => {
                            if(data.value) chat.addBubble(atob(data.value), 'other');
                        });
                    }
                }, () => alert("Gagal Terhubung"));
            },
            
            addBubble: (txt, who) => {
                let d = document.createElement('div');
                d.className = `bubble ${who}`;
                d.innerText = txt;
                document.getElementById('msgs-list').appendChild(d);
            }
        };

        function sendMsg() {
            let txt = document.getElementById('msg-in').value;
            if(!txt) return;
            
            let b64 = btoa(txt);
            ble.write({ 
                address: activeAddr, 
                service: APP_UUID, 
                characteristic: CHAR_UUID, 
                value: b64, 
                type: "noResponse" 
            }, () => {
                chat.addBubble(txt, 'me');
                document.getElementById('msg-in').value = "";
            });
        }

        function closeChat() {
            document.getElementById('chat-view').style.display = 'none';
            if(activeAddr) ble.disconnect({ address: activeAddr });
        }

        function toggleTheme() {
            if(document.body.getAttribute('data-theme') === 'dark') {
                document.body.removeAttribute('data-theme');
            } else {
                document.body.setAttribute('data-theme', 'dark');
            }
        }
    </script>
</body>
</html>
