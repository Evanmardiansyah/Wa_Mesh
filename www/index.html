<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; media-src *; img-src * data: content:;">
    
    <title>Nusa Mesh Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary: #008069; --bg-chat: #e5ddd5; --me: #dcf8c6; --other: #fff; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #fff; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }

        /* HEADER */
        header { background: var(--primary); color: white; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .app-info { display: flex; flex-direction: column; }
        .app-name { font-weight: bold; font-size: 18px; }
        .status-text { font-size: 11px; opacity: 0.9; margin-top: 2px; display: flex; align-items: center; }
        .dot { width: 8px; height: 8px; background: #0f0; border-radius: 50%; margin-right: 5px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%{opacity:1} 50%{opacity:0.3} 100%{opacity:1} }

        .tabs { display: flex; background: var(--primary); color: rgba(255,255,255,0.7); }
        .tab { flex: 1; padding: 12px; text-align: center; text-transform: uppercase; font-size: 13px; font-weight: bold; border-bottom: 3px solid transparent; cursor: pointer; }
        .tab.active { color: white; border-bottom: 3px solid white; }

        /* LIST VIEW */
        #main-view { flex: 1; position: relative; background: white; }
        .page { display: none; height: 100%; overflow-y: auto; }
        .page.active { display: block; }
        
        .item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; cursor: pointer; transition: 0.2s; }
        .item:active { background: #f5f5f5; }
        .avatar { width: 45px; height: 45px; background: #ddd; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; color: white; margin-right: 15px; }
        .online-badge { border: 2px solid white; width: 12px; height: 12px; background: #25D366; border-radius: 50%; position: absolute; bottom: 0; right: 0; }
        
        .info h3 { margin: 0; font-size: 16px; color: #333; }
        .info p { margin: 3px 0 0; font-size: 12px; color: #888; }
        .badge { font-size: 10px; background: #eee; padding: 3px 6px; border-radius: 4px; margin-left: auto; }

        /* CHAT ROOM */
        #chat-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-chat); z-index: 100; display: none; flex-direction: column; }
        .chat-head { background: var(--primary); padding: 8px 10px; display: flex; align-items: center; color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .back-icon { padding: 8px; margin-right: 5px; cursor: pointer; }
        
        #msgs { flex: 1; padding: 10px; overflow-y: auto; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: cover; display: flex; flex-direction: column; }
        
        .bubble { max-width: 80%; padding: 6px 10px; margin-bottom: 8px; border-radius: 8px; font-size: 15px; position: relative; word-wrap: break-word; box-shadow: 0 1px 1px rgba(0,0,0,0.1); display: inline-block; }
        .bubble.me { align-self: flex-end; background: var(--me); border-top-right-radius: 0; }
        .bubble.other { align-self: flex-start; background: var(--other); border-top-left-radius: 0; }
        .bubble img { max-width: 100%; border-radius: 6px; margin-top: 5px; display: block; }
        
        .file-box { display: flex; align-items: center; background: rgba(0,0,0,0.05); padding: 5px; border-radius: 5px; margin-top: 5px; }
        .file-icon { font-size: 24px; color: #e74c3c; margin-right: 10px; }
        .file-info { font-size: 12px; font-weight: bold; }
        
        .meta { display: flex; justify-content: flex-end; align-items: center; margin-top: 2px; font-size: 10px; color: #999; }

        /* FOOTER */
        .footer { padding: 5px 8px; background: #f0f0f0; display: flex; align-items: flex-end; min-height: 50px; gap: 8px; }
        textarea { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; outline: none; font-size: 16px; max-height: 100px; resize: none; min-height: 40px; font-family: inherit; }
        .btn { width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #555; cursor: pointer; font-size: 18px; }
        .btn-send { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* PROGRESS BAR */
        #progress-modal { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 200; display: none; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .prog-bar { width: 80%; height: 10px; background: #555; border-radius: 5px; margin-top: 15px; overflow: hidden; }
        .prog-fill { height: 100%; background: #25D366; width: 0%; transition: width 0.2s; }
        
        /* ATTACH MENU */
        #attach-menu { position: absolute; bottom: 65px; left: 10px; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; flex-direction: column; width: 160px; z-index: 101; }
        .attach-item { padding: 12px 15px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px; color: #333; }
        .attach-item i { width: 30px; }
    </style>
</head>
<body>

    <header>
        <div class="app-info">
            <div class="app-name">Nusa Mesh Pro</div>
            <div class="status-text"><div class="dot"></div> Online (Visible)</div>
        </div>
        <i class="fas fa-sync" onclick="forceScan()" style="cursor:pointer;"></i>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="nav('personal')" id="t-personal">Chat</div>
        <div class="tab" onclick="nav('nearby')" id="t-nearby">Radar</div>
    </div>

    <div id="main-view">
        <div id="p-personal" class="page active">
            <div style="padding:20px; text-align:center; color:#888;" id="empty-msg">Belum ada chat.</div>
            <div id="list-personal"></div>
        </div>
        <div id="p-nearby" class="page">
            <div style="background:#e3f2fd; padding:10px; font-size:12px; color:#0d47a1; text-align:center;">
                <i class="fas fa-satellite-dish"></i> Radar aktif. Perangkat sekitar akan muncul di sini.
            </div>
            <div id="list-nearby"></div>
        </div>
    </div>

    <div id="chat-view">
        <div class="chat-head">
            <i class="fas fa-arrow-left back-icon" onclick="closeChat()"></i>
            <div class="avatar" style="width:35px; height:35px; font-size:16px; margin-right:10px;"><i class="fas fa-user"></i></div>
            <div style="flex:1;">
                <div style="font-weight:bold; font-size:16px;" id="chat-name">User</div>
                <div style="font-size:11px; opacity:0.8;">Connected via Bluetooth</div>
            </div>
        </div>
        
        <div id="msgs"></div>
        
        <div id="attach-menu">
            <div class="attach-item" onclick="pickImage()"><i class="fas fa-image" style="color:#d32f2f;"></i> Kirim Foto</div>
            <div class="attach-item" onclick="pickFile()"><i class="fas fa-file-alt" style="color:#5e35b1;"></i> Kirim File</div>
        </div>

        <div class="footer">
            <div class="btn" onclick="toggleAttach()"><i class="fas fa-paperclip" style="transform: rotate(45deg);"></i></div>
            <textarea id="txt" placeholder="Ketik pesan..." rows="1"></textarea>
            <div class="btn btn-send" onclick="sendText()"><i class="fas fa-paper-plane"></i></div>
        </div>
    </div>

    <div id="progress-modal">
        <h3 id="prog-title">Mengirim...</h3>
        <div style="font-size:20px; font-weight:bold;" id="prog-text">0%</div>
        <div class="prog-bar"><div class="prog-fill" id="prog-fill"></div></div>
        <div style="margin-top:10px; font-size:12px; color:#ccc;">Jangan keluar aplikasi!</div>
    </div>

    <input type="file" id="inp-img" accept="image/*" style="display:none" onchange="procImg(this)">
    <input type="file" id="inp-file" style="display:none" onchange="procFile(this)">

    <script type="text/javascript" src="cordova.js"></script>
    <script>
        var bt = null;
        var CHUNK_SIZE = 900; 
        var incomingFile = { meta: null, data: [], received: 0 };
        var isSending = false;

        document.addEventListener('deviceready', function() {
            bt = window.bluetoothClassicSerialPort;
            
            // 1. IZIN MANUAL BRUTAL (Resep Nusa Mesh)
            requestPermsManual();

            // Auto-expand textarea
            document.getElementById('txt').addEventListener('input', function(){
                this.style.height='auto'; this.style.height=(this.scrollHeight)+'px';
                if(this.value=='') this.style.height='40px';
            });
        }, false);

        // --- CORE KONEKSI (RESEP FIX LIST KOSONG) ---
        function requestPermsManual() {
            var p = cordova.plugins.permissions;
            var perms = [
                "android.permission.BLUETOOTH_SCAN", 
                "android.permission.BLUETOOTH_CONNECT", 
                "android.permission.BLUETOOTH_ADVERTISE", 
                "android.permission.ACCESS_FINE_LOCATION",
                "android.permission.READ_EXTERNAL_STORAGE" // Tambah Storage buat file
            ];

            p.requestPermissions(perms, function(status) {
                if(status.hasPermission) {
                    startApp();
                } else {
                    alert("Wajib Izinkan Semua ya Bre! Biar bisa scan & kirim file.");
                    p.requestPermissions(perms, startApp, function(){});
                }
            }, function(){});
        }

        function startApp() {
            // 2. AUTO VISIBLE (Resep Nusa Mesh)
            bt.setDiscoverable(300);

            // 3. START LISTENING
            bt.listen(function(){ console.log("Server OK"); }, function(e){});
            
            // 4. DATA HANDLER (Chunking Logic)
            bt.subscribeRaw(function(data){
                handleRawData(data);
            });

            // 5. AUTO SCAN
            loadLists();
        }

        function forceScan() {
            bt.setDiscoverable(300); // Perbarui visibility
            loadLists();
        }

        function loadLists() {
            var elNearby = document.getElementById('list-nearby');
            elNearby.innerHTML = "<div style='padding:20px; text-align:center; color:#888;'>Scanning...</div>";
            
            var allDevs = [];

            // Get Paired
            bt.list(function(paired) {
                renderPaired(paired);
                paired.forEach(d => { d.isPaired=true; allDevs.push(d); });

                // Get Unpaired
                bt.discoverUnpaired(function(unpaired) {
                    unpaired.forEach(d => {
                        if(!allDevs.find(x => x.address == d.address)) {
                            d.isPaired = false;
                            allDevs.push(d);
                        }
                    });
                    renderNearby(allDevs);
                }, function(e){
                    renderNearby(allDevs); // Tetap render paired kalau scan gagal
                });
            }, function(){});
        }

        function renderPaired(list) {
            var el = document.getElementById('list-personal');
            el.innerHTML = "";
            if(list.length>0) document.getElementById('empty-msg').style.display='none';
            
            list.forEach(d => {
                el.innerHTML += `
                <div class="item" onclick="connect('${d.address}', '${d.name}')">
                    <div class="avatar"><i class="fas fa-user"></i></div>
                    <div class="info"><h3>${d.name}</h3><p>Tersimpan</p></div>
                </div>`;
            });
        }

        function renderNearby(list) {
            var el = document.getElementById('list-nearby');
            el.innerHTML = "";
            list.forEach(d => {
                if(!d.name) return;
                var badge = d.isPaired ? "Saved" : "New";
                var color = d.isPaired ? "#25D366" : "#ddd";
                el.innerHTML += `
                <div class="item" onclick="connect('${d.address}', '${d.name}')">
                    <div class="avatar" style="position:relative;">
                        <i class="fas fa-mobile-alt"></i>
                        <div class="online-badge" style="background:${color}"></div>
                    </div>
                    <div class="info"><h3>${d.name}</h3><p>${d.address}</p></div>
                    <div class="badge">${badge}</div>
                </div>`;
            });
        }

        function connect(addr, name) {
            showProgress("Menghubungkan...", 100);
            bt.connectInsecure(addr, function() {
                hideProgress();
                openChat(name);
            }, function(e) {
                hideProgress();
                alert("Gagal konek: " + e);
            });
        }

        // --- CORE PENGOLAH DATA (FILE TRANSFER) ---
        function handleRawData(buffer) {
            var chunk = String.fromCharCode.apply(null, new Uint8Array(buffer));
            
            // Header Check
            if(chunk.startsWith("HEAD:")) {
                var parts = chunk.split(":");
                incomingFile.meta = { type: parts[1], name: parts[2], size: parseInt(parts[3]) };
                incomingFile.data = [];
                incomingFile.received = 0;
                showProgress("Menerima: " + parts[2], 0);
                return;
            }

            // Receiving Data
            if(incomingFile.meta) {
                incomingFile.data.push(chunk);
                incomingFile.received += chunk.length;
                var pct = Math.floor((incomingFile.received / incomingFile.meta.size) * 100);
                updateProgress(pct);

                if(chunk.endsWith("END")) {
                    var fullStr = incomingFile.data.join("").replace("END", "");
                    renderIncoming(incomingFile.meta, fullStr);
                    incomingFile.meta = null;
                    hideProgress();
                }
                return;
            }

            // Text Msg
            if(chunk.startsWith("TXT:")) {
                addBubble(chunk.substring(4), 'other', 'text');
            }
        }

        function sendLargeData(type, name, base64Str) {
            if(isSending) return alert("Antrian penuh!");
            isSending = true;
            var size = base64Str.length;
            var header = "HEAD:" + type + ":" + name + ":" + size;
            
            showProgress("Mengirim...", 0);
            
            bt.write(header, function(){
                var offset = 0;
                function sendChunk() {
                    if(offset >= size) {
                        bt.write("END", function(){
                            isSending = false;
                            hideProgress();
                            if(type==='IMG') addBubble(base64Str, 'me', 'img');
                            else addBubble(name, 'me', 'file');
                        }, null);
                        return;
                    }
                    var chunk = base64Str.substring(offset, offset + CHUNK_SIZE);
                    bt.write(chunk, function(){
                        offset += CHUNK_SIZE;
                        updateProgress(Math.floor((offset/size)*100));
                        setTimeout(sendChunk, 20); // Delay Stabilizer
                    }, function(){ isSending=false; hideProgress(); alert("Fail"); });
                }
                sendChunk();
            }, function(){ isSending=false; alert("Fail Head"); });
        }

        // --- UI & UTILS ---
        function openChat(name) {
            document.getElementById('chat-view').style.display = 'flex';
            document.getElementById('chat-name').innerText = name;
            document.getElementById('msgs').innerHTML = "";
        }
        function closeChat() {
            bt.disconnect();
            document.getElementById('chat-view').style.display = 'none';
        }
        function sendText() {
            var t = document.getElementById('txt').value.trim();
            if(!t) return;
            bt.write("TXT:"+t, function(){
                addBubble(t, 'me', 'text');
                document.getElementById('txt').value="";
            }, null);
        }
        function addBubble(content, who, type) {
            var div = document.createElement('div');
            div.className = "bubble " + who;
            var time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            var meta = `<div class="meta">${time}</div>`;
            
            if(type==='text') div.innerHTML = content + meta;
            else if(type==='img') div.innerHTML = `<img src="data:image/jpeg;base64,${content}">` + meta;
            else if(type==='file') div.innerHTML = `<div class="file-box"><i class="fas fa-file file-icon"></i><div class="file-info">${content}</div></div>` + meta;
            
            document.getElementById('msgs').appendChild(div);
            document.getElementById('msgs').scrollTop = 99999;
        }

        // --- ATTACHMENT LOGIC ---
        function toggleAttach() { 
            var m = document.getElementById('attach-menu');
            m.style.display = (m.style.display==='flex') ? 'none' : 'flex'; 
        }
        function pickImage() { document.getElementById('inp-img').click(); toggleAttach(); }
        function pickFile() { document.getElementById('inp-file').click(); toggleAttach(); }
        
        function procImg(inp) {
            if(inp.files[0]) {
                var f = inp.files[0];
                var r = new FileReader();
                r.onload = function(e) {
                    var img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        var c = document.createElement('canvas');
                        var ctx = c.getContext('2d');
                        var s = 600/img.width;
                        c.width=600; c.height=img.height*s;
                        ctx.drawImage(img,0,0,c.width,c.height);
                        var d = c.toDataURL('image/jpeg', 0.7).split(',')[1];
                        sendLargeData("IMG", f.name, d);
                    }
                };
                r.readAsDataURL(f);
            }
        }
        
        function procFile(inp) {
            if(inp.files[0]) {
                var f = inp.files[0];
                if(f.size > 500*1024) return alert("Max 500KB!");
                var r = new FileReader();
                r.onload = function(e) {
                    sendLargeData("FILE", f.name, e.target.result.split(',')[1]);
                };
                r.readAsDataURL(f);
            }
        }
        
        function renderIncoming(meta, data) {
            if(meta.type==='IMG') addBubble(data, 'other', 'img');
            else addBubble(meta.name, 'other', 'file');
        }

        function showProgress(t, p) { 
            document.getElementById('progress-modal').style.display='flex';
            document.getElementById('prog-title').innerText=t;
            updateProgress(p);
        }
        function updateProgress(p) {
            if(p>100)p=100;
            document.getElementById('prog-text').innerText=p+"%";
            document.getElementById('prog-fill').style.width=p+"%";
        }
        function hideProgress() { document.getElementById('progress-modal').style.display='none'; }
        
        function nav(p) {
            document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
            document.getElementById('t-'+p).classList.add('active');
            document.getElementById('p-'+p).classList.add('active');
            if(p==='nearby') loadLists();
        }
    </script>
</body>
</html>
