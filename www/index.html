<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; media-src *;">
    <title>WA Bluetooth</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --wa-teal: #008069; --wa-bg: #e5ddd5; --active-tab: #ffffff; --inactive-tab: #8adad1; }
        body { margin: 0; font-family: sans-serif; background: #fff; user-select: none; display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER & TABS */
        header { background-color: var(--wa-teal); color: white; padding-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
        .top-bar { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .title { font-size: 20px; font-weight: bold; }
        
        .tabs { display: flex; margin-top: 10px; }
        .tab { flex: 1; text-align: center; padding: 10px; text-transform: uppercase; font-size: 14px; font-weight: bold; color: var(--inactive-tab); cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { color: var(--active-tab); border-bottom: 3px solid white; }

        /* CONTENT AREA */
        #main-content { flex: 1; overflow-y: auto; background: #fff; position: relative; }
        
        /* LIST DEVICES */
        .device-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; cursor: pointer; }
        .device-icon { width: 45px; height: 45px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: white; font-size: 20px; }
        .device-info { flex: 1; }
        .device-name { font-weight: bold; font-size: 16px; color: #333; }
        .device-addr { font-size: 12px; color: #888; margin-top: 2px; }
        .status-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #555; }

        /* CHAT ROOM (Overlay) */
        #chat-room { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #e5ddd5; z-index: 20; display: none; flex-direction: column; }
        .chat-header { background: var(--wa-teal); padding: 10px; color: white; display: flex; align-items: center; }
        .chat-area { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-opacity:0.5;}
        
        .msg { max-width: 75%; padding: 8px 12px; margin-bottom: 5px; border-radius: 8px; font-size: 15px; position: relative; word-wrap: break-word; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg.me { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 0; }
        .msg.other { align-self: flex-start; background: #fff; border-top-left-radius: 0; }

        .chat-input { padding: 5px; background: #f0f0f0; display: flex; align-items: center; }
        input { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; margin: 0 5px; }
        .btn-send { width: 40px; height: 40px; background: var(--wa-teal); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-left: 5px; cursor: pointer; }

        /* Loading */
        .loading { text-align: center; padding: 20px; color: #888; display: none; }
        .error-box { padding: 20px; text-align: center; color: #d32f2f; display: none; }
    </style>
</head>
<body>

    <header>
        <div class="top-bar">
            <div class="title">WA Bluetooth</div>
            <i class="fas fa-ellipsis-v"></i>
        </div>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('personal')" id="tab-personal">Personal</div>
            <div class="tab" onclick="switchTab('nearby')" id="tab-nearby">Nearby (Sekitar)</div>
        </div>
    </header>

    <div id="main-content">
        <div id="view-personal">
            <div class="loading" id="load-personal">Memuat perangkat tersimpan...</div>
            <div id="list-personal"></div>
        </div>

        <div id="view-nearby" style="display: none;">
            <div style="padding:15px; background:#e3f2fd; font-size:12px; color:#0d47a1;">
                <i class="fas fa-info-circle"></i> Fitur Nearby akan mencari perangkat Bluetooth aktif di sekitar yang belum dipairing.
            </div>
            <div class="loading" id="load-nearby">Sedang memindai sekitar...</div>
            <button onclick="scanNearby()" style="width:90%; margin:5%; padding:10px; background:var(--wa-teal); color:white; border:none; border-radius:5px;">SCAN ULANG</button>
            <div id="list-nearby"></div>
        </div>
    </div>

    <div id="chat-room">
        <div class="chat-header">
            <i class="fas fa-arrow-left" onclick="tutupChat()" style="margin-right: 15px; cursor: pointer;"></i>
            <div style="flex:1;">
                <div id="chat-name" style="font-weight: bold;">Nama Kontak</div>
                <div id="chat-status" style="font-size: 11px;">Terhubung</div>
            </div>
        </div>
        <div class="chat-area" id="msg-area"></div>
        <div class="chat-input">
            <input type="text" id="msg-input" placeholder="Ketik pesan...">
            <div class="btn-send" onclick="kirimPesan()"><i class="fas fa-paper-plane"></i></div>
        </div>
    </div>

    <script type="text/javascript" src="cordova.js"></script>
    <script>
        document.addEventListener('deviceready', onDeviceReady, false);

        function onDeviceReady() {
            // 1. MINTA IZIN DULU (KHUSUS ANDROID 12+)
            requestPermissions();
        }

        // --- LOGIKA PERMISSION / IZIN ---
        function requestPermissions() {
            var permissions = cordova.plugins.permissions;
            var list = [
                permissions.BLUETOOTH_SCAN,
                permissions.BLUETOOTH_CONNECT,
                permissions.BLUETOOTH_ADVERTISE,
                permissions.ACCESS_FINE_LOCATION
            ];

            permissions.checkPermission(list, function(status) {
                if(!status.hasPermission) {
                    permissions.requestPermissions(list, function(status) {
                        if(status.hasPermission) {
                            console.log("Izin Diberikan!");
                            loadPairedDevices(); // Langsung load data
                        } else {
                            alert("Aplikasi butuh izin Bluetooth agar bisa jalan, Bro!");
                        }
                    }, function() { alert("Gagal request izin."); });
                } else {
                    loadPairedDevices(); // Sudah punya izin
                }
            });
            
            // Cek Bluetooth Nyala/Gak
            bluetoothSerial.isEnabled(null, function() {
                bluetoothSerial.enable();
            });
            
            // Listen pesan masuk
            bluetoothSerial.subscribe('\n', function(data){ tampilkanPesan(data, 'other'); }, null);
        }

        // --- LOGIKA TABS ---
        function switchTab(tabName) {
            // Ganti Style Tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');

            // Ganti Tampilan
            document.getElementById('view-personal').style.display = (tabName === 'personal') ? 'block' : 'none';
            document.getElementById('view-nearby').style.display = (tabName === 'nearby') ? 'block' : 'none';

            if(tabName === 'personal') loadPairedDevices();
            if(tabName === 'nearby') scanNearby();
        }

        // --- PERSONAL (PAIRED) ---
        function loadPairedDevices() {
            document.getElementById('load-personal').style.display = 'block';
            document.getElementById('list-personal').innerHTML = "";
            
            bluetoothSerial.list(function(devices) {
                document.getElementById('load-personal').style.display = 'none';
                devices.forEach(device => {
                    renderDevice(device, 'list-personal', true);
                });
                if(devices.length === 0) document.getElementById('list-personal').innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>Belum ada perangkat dipairing.</div>";
            }, function() {});
        }

        // --- NEARBY (DISCOVERY) ---
        function scanNearby() {
            document.getElementById('load-nearby').style.display = 'block';
            document.getElementById('list-nearby').innerHTML = "";

            // Fungsi discoverUnpaired (Mencari perangkat yang belum pair)
            bluetoothSerial.discoverUnpaired(function(devices) {
                document.getElementById('load-nearby').style.display = 'none';
                devices.forEach(device => {
                    renderDevice(device, 'list-nearby', false);
                });
                if(devices.length === 0) document.getElementById('list-nearby').innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>Tidak ada perangkat terdeteksi.</div>";
            }, function(err) {
                document.getElementById('load-nearby').style.display = 'none';
                alert("Gagal scan: " + err);
            });
        }

        // --- RENDER LIST ---
        function renderDevice(device, targetId, isPaired) {
            if(!device.name) return; // Skip yang gak ada namanya
            
            let html = `
            <div class="device-item" onclick="connectTo('${device.address}', '${device.name}')">
                <div class="device-icon" style="background:${isPaired ? '#008069' : '#666'}">
                    <i class="fas ${isPaired ? 'fa-user' : 'fa-broadcast-tower'}"></i>
                </div>
                <div class="device-info">
                    <div class="device-name">${device.name}</div>
                    <div class="device-addr">${device.address}</div>
                </div>
                ${isPaired ? '' : '<span class="status-badge">Tap to Connect</span>'}
            </div>`;
            document.getElementById(targetId).innerHTML += html;
        }

        // --- KONEKSI & CHAT ---
        function connectTo(address, name) {
            alert("Menghubungkan ke " + name + "...");
            bluetoothSerial.connectInsecure(address, function() {
                // Sukses
                document.getElementById('chat-room').style.display = 'flex';
                document.getElementById('chat-name').innerText = name;
                document.getElementById('msg-area').innerHTML = ""; // Bersihkan chat lama
                tampilkanPesan("Terhubung ke chat!", "me");
            }, function(err) {
                alert("Gagal konek: " + err + "\n\nTips: Kalau di Nearby, kadang perlu pairing manual dulu di setting HP.");
            });
        }

        function tutupChat() {
            bluetoothSerial.disconnect();
            document.getElementById('chat-room').style.display = 'none';
        }

        function kirimPesan() {
            let input = document.getElementById('msg-input');
            let text = input.value;
            if(!text) return;

            bluetoothSerial.write(text + "\n", function() {
                tampilkanPesan(text, 'me');
                input.value = "";
            }, function() { alert("Gagal kirim, koneksi putus."); });
        }

        function tampilkanPesan(text, who) {
            let area = document.getElementById('msg-area');
            let div = document.createElement('div');
            div.className = 'msg ' + who;
            div.innerText = text;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }
    </script>
</body>
</html>
