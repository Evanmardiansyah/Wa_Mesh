<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval';">
    
    <title>Messenger Mesh</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME SYSTEM --- */
        :root {
            --primary: #2563eb;
            --bg-app: #f8f9fa;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --nav-bg: #ffffff;
            --me-bubble: #2563eb;
            --me-text: #fff;
        }
        [data-theme="dark"] {
            --primary: #60a5fa;
            --bg-app: #111827;
            --bg-card: #1f2937;
            --text-main: #f3f4f6;
            --text-sub: #9ca3af;
            --border: #374151;
            --nav-bg: #1f2937;
            --me-bubble: #3b82f6;
        }

        body { margin:0; font-family:'Inter',sans-serif; background:var(--bg-app); color:var(--text-main); height:100vh; display:flex; flex-direction:column; overflow:hidden; }

        /* --- SETUP SCREEN (ONBOARDING) --- */
        #setup-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-card); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px; text-align:center; overflow-y:auto; }
        .setup-title { font-size:24px; font-weight:800; color:var(--primary); margin-bottom:10px; }
        .setup-step { width:100%; max-width:350px; text-align:left; margin-bottom:20px; }
        .setup-label { font-size:14px; font-weight:600; margin-bottom:8px; display:block; color:var(--text-sub); }
        .setup-input { width:100%; padding:15px; border-radius:12px; border:2px solid var(--border); background:var(--bg-app); color:var(--text-main); font-size:16px; outline:none; transition:0.3s; }
        .setup-input:focus { border-color:var(--primary); }
        
        /* Avatar & Gender Selector */
        .grid-select { display:flex; gap:10px; overflow-x:auto; padding-bottom:5px; }
        .choice-card { border:2px solid var(--border); border-radius:12px; padding:10px; cursor:pointer; min-width:80px; text-align:center; transition:0.2s; opacity:0.6; }
        .choice-card.selected { border-color:var(--primary); background:rgba(37,99,235,0.1); opacity:1; transform:scale(1.05); }
        .choice-icon { font-size:24px; margin-bottom:5px; display:block; }
        
        .btn-start { background:var(--primary); color:white; width:100%; padding:15px; border-radius:15px; border:none; font-weight:bold; font-size:16px; margin-top:20px; box-shadow:0 5px 15px rgba(37,99,235,0.3); }

        /* --- MAIN APP --- */
        #app-container { display:none; flex-direction:column; height:100%; }
        
        /* HEADER */
        header { padding:20px 20px 10px; background:var(--bg-app); display:flex; justify-content:space-between; align-items:center; }
        .head-title { font-size:24px; font-weight:800; }
        .status-badge { font-size:12px; background:rgba(16,185,129,0.1); color:#10b981; padding:4px 10px; border-radius:20px; display:flex; align-items:center; gap:5px; font-weight:600; }
        .pulse { width:8px; height:8px; background:#10b981; border-radius:50%; animation:ping 1.5s infinite; }
        @keyframes ping { 0%{box-shadow:0 0 0 0 rgba(16,185,129,0.7);} 70%{box-shadow:0 0 0 5px rgba(16,185,129,0);} 100%{box-shadow:0 0 0 0 rgba(16,185,129,0);} }

        /* PAGES */
        #pages { flex:1; position:relative; overflow:hidden; }
        .page { position:absolute; top:0; left:0; width:100%; height:100%; overflow-y:auto; display:none; padding-bottom:80px; }
        .page.active { display:block; animation:fadeUp 0.3s; }
        @keyframes fadeUp { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* LIST ITEMS */
        .list-item { padding:15px 20px; background:var(--bg-card); margin-bottom:1px; display:flex; align-items:center; cursor:pointer; border-bottom:1px solid var(--border); transition:0.2s; }
        .list-item:active { background:var(--bg-app); }
        .avatar-circle { width:45px; height:45px; background:#e0f2fe; color:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px; margin-right:15px; position:relative; }
        .online-dot { position:absolute; bottom:0; right:0; width:12px; height:12px; background:#10b981; border:2px solid var(--bg-card); border-radius:50%; }
        
        /* RADAR */
        .radar-box { text-align:center; padding:40px 20px; }
        .radar-circle { width:80px; height:80px; background:rgba(37,99,235,0.1); border-radius:50%; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; color:var(--primary); font-size:30px; }

        /* PROFILE */
        .profile-card { background:var(--bg-card); margin:20px; padding:30px; border-radius:20px; text-align:center; border:1px solid var(--border); }
        .my-avatar { width:90px; height:90px; background:#f3f4f6; border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:40px; color:#333; }
        
        /* BOTTOM NAV (FLOATING) */
        .nav { position:fixed; bottom:20px; left:20px; right:20px; background:var(--nav-bg); padding:15px; border-radius:20px; display:flex; justify-content:space-around; box-shadow:0 10px 30px rgba(0,0,0,0.1); z-index:50; }
        .nav-item { text-align:center; color:var(--text-sub); font-size:10px; font-weight:600; opacity:0.7; transition:0.2s; }
        .nav-item.active { color:var(--primary); opacity:1; transform:translateY(-2px); }
        .nav-icon { font-size:20px; margin-bottom:5px; display:block; }

        /* CHAT ROOM */
        #chat-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-app); z-index:100; display:none; flex-direction:column; }
        .chat-head { padding:15px; background:var(--bg-card); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; }
        #msgs { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px; }
        .bubble { max-width:75%; padding:10px 15px; border-radius:15px; font-size:14px; word-wrap:break-word; }
        .me { align-self:flex-end; background:var(--me-bubble); color:var(--me-text); border-bottom-right-radius:2px; }
        .other { align-self:flex-start; background:var(--bg-card); border:1px solid var(--border); border-bottom-left-radius:2px; }
        .input-bar { padding:10px; background:var(--bg-card); display:flex; gap:10px; border-top:1px solid var(--border); }
        .input-bar input { flex:1; padding:10px 15px; border-radius:20px; border:1px solid var(--border); background:var(--bg-app); color:var(--text-main); outline:none; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <div class="setup-title">Messenger Mesh</div>
        <p style="color:gray; margin-bottom:30px;">Buat identitas untuk chat di jaringan lokal.</p>
        
        <div class="setup-step">
            <label class="setup-label">Nama Kamu</label>
            <input type="text" id="setup-name" class="setup-input" placeholder="Misal: Captain Indo">
        </div>

        <div class="setup-step">
            <label class="setup-label">Gender</label>
            <div class="grid-select">
                <div class="choice-card" onclick="selGender('Laki', this)" id="g-laki"><span class="choice-icon">ðŸ‘¨</span>Laki</div>
                <div class="choice-card" onclick="selGender('Perempuan', this)" id="g-pr"><span class="choice-icon">ðŸ‘©</span>Pr</div>
            </div>
        </div>

        <div class="setup-step">
            <label class="setup-label">Pilih Avatar</label>
            <div class="grid-select">
                <div class="choice-card" onclick="selAvatar('robot', this)"><span class="choice-icon">ðŸ¤–</span></div>
                <div class="choice-card" onclick="selAvatar('alien', this)"><span class="choice-icon">ðŸ‘½</span></div>
                <div class="choice-card" onclick="selAvatar('ninja', this)"><span class="choice-icon">ðŸ¥·</span></div>
                <div class="choice-card" onclick="selAvatar('ghost', this)"><span class="choice-icon">ðŸ‘»</span></div>
            </div>
        </div>

        <button class="btn-start" onclick="saveSetup()">GABUNG NETWORK</button>
    </div>

    <div id="app-container">
        <header>
            <div>
                <div class="head-title">Radar</div>
                <div style="font-size:12px; color:gray;" id="my-identity">Menunggu...</div>
            </div>
            <div class="status-badge"><div class="pulse"></div> BLE On</div>
        </header>

        <div id="pages">
            <div id="p-radar" class="page active">
                <div class="radar-box">
                    <div class="radar-circle"><i class="fas fa-search-location"></i></div>
                    <h3>Scanning...</h3>
                    <p style="color:gray; font-size:13px;">HP lain di radius 20m akan muncul di bawah.</p>
                </div>
                <div style="padding:0 20px; font-weight:bold; margin-bottom:10px; color:var(--text-sub);">ORANG DI SEKITAR:</div>
                <div id="list-nearby"></div>
            </div>

            <div id="p-profile" class="page">
                <div class="profile-card">
                    <div class="my-avatar" id="prof-avatar">ðŸ¤–</div>
                    <h2 id="prof-name">User</h2>
                    <div style="font-size:12px; background:#eee; color:#333; padding:5px 10px; border-radius:10px; display:inline-block;" id="prof-gender">Gender</div>
                    <br><br>
                    <div style="font-family:monospace; color:gray;" id="prof-id">ID: XXX</div>
                </div>
                <div class="profile-card" style="text-align:left; padding:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span><i class="fas fa-moon"></i> Dark Mode</span>
                        <input type="checkbox" onclick="toggleTheme()" id="theme-tog">
                    </div>
                </div>
            </div>
        </div>

        <div class="nav">
            <div class="nav-item active" id="n-radar" onclick="nav('radar')">
                <i class="fas fa-radar nav-icon"></i> Radar
            </div>
            <div class="nav-item" id="n-profile" onclick="nav('profile')">
                <i class="fas fa-user-circle nav-icon"></i> Profil
            </div>
        </div>
    </div>

    <div id="chat-screen">
        <div class="chat-head">
            <i class="fas fa-arrow-left" onclick="closeChat()" style="font-size:20px;"></i>
            <b id="chat-title">User</b>
        </div>
        <div id="msgs"></div>
        <div class="input-bar">
            <input type="text" id="chat-input" placeholder="Tulis pesan rahasia...">
            <i class="fas fa-paper-plane" onclick="sendMsg()" style="font-size:24px; color:var(--primary); align-self:center;"></i>
        </div>
    </div>

    <script src="cordova.js"></script>
    <script>
        var ble;
        // UUID: Heart Rate Service (Standar) agar mudah dideteksi
        var MESH_SERVICE = "180D"; 
        var MESH_CHAR = "2A37"; 
        
        var user = { name:"", gender:"", avatar:"ðŸ¤–", id:"" };
        var activeAddr = "";

        document.addEventListener('deviceready', function() {
            ble = window.bluetoothle;
            checkLogin();
        }, false);

        // --- SETUP ---
        var tempGender="", tempAvatar="ðŸ¤–";
        function selGender(g, el) { tempGender=g; document.querySelectorAll('#g-laki, #g-pr').forEach(x=>x.classList.remove('selected')); el.classList.add('selected'); }
        function selAvatar(a, el) { var i={'robot':'ðŸ¤–','alien':'ðŸ‘½','ninja':'ðŸ¥·','ghost':'ðŸ‘»'}; tempAvatar=i[a]; document.querySelectorAll('.choice-card').forEach(x=>x.classList.remove('selected')); el.classList.add('selected'); }

        function saveSetup() {
            var n = document.getElementById('setup-name').value.trim();
            if(!n || !tempGender) return alert("Lengkapi data dulu!");
            var id = "AGT-" + Math.floor(Math.random()*999);
            localStorage.setItem('mesh_user', JSON.stringify({ name:n, gender:tempGender, avatar:tempAvatar, id:id }));
            checkLogin();
        }

        function checkLogin() {
            var s = localStorage.getItem('mesh_user');
            if(s) {
                user = JSON.parse(s);
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                
                // Update Info UI
                document.getElementById('my-identity').innerText = user.name;
                document.getElementById('prof-name').innerText = user.name;
                document.getElementById('prof-avatar').innerText = user.avatar;
                document.getElementById('prof-gender').innerText = user.gender;
                document.getElementById('prof-id').innerText = user.id;

                initBLE();
            }
        }

        // --- BLE ENGINE ---
        function initBLE() {
            var p = cordova.plugins.permissions;
            p.requestPermissions([p.ACCESS_FINE_LOCATION, p.BLUETOOTH_SCAN, p.BLUETOOTH_ADVERTISE, p.BLUETOOTH_CONNECT], 
            function(){ startEngine(); }, function(){ alert("Izin Bluetooth Ditolak!"); });
        }

        function startEngine() {
            ble.initialize(function(status){
                if(status.status === 'enabled') {
                    // 1. Mulai Broadcast Diri Sendiri (Biar orang lain liat)
                    advertiseMyself();
                    // 2. Mulai Scan Orang Lain (Biar kita liat orang lain)
                    scanOthers();
                }
            });
        }

        function advertiseMyself() {
            ble.initializePeripheral({ request:true }, function(res){
                if(res.status==='enabled') {
                    ble.addService({
                        service: MESH_SERVICE,
                        characteristics: [{ uuid:MESH_CHAR, permissions:{read:true,write:true}, properties:{read:true,write:true,notify:true} }]
                    }, function(){
                        // Advertise Nama User
                        ble.startAdvertising({ services:[MESH_SERVICE], service:MESH_SERVICE, name:user.name }, 
                        function(){ console.log("Broadcasting OK"); }, function(e){ console.log("Broadcast Fail",e); });
                    }, function(){});
                }
            }, function(){});
        }

        function scanOthers() {
            ble.startScan({ services:[MESH_SERVICE] }, function(res){
                if(res.status === 'scanResult') {
                    renderPerson(res);
                }
            }, function(e){ console.log("Scan Error",e); });
        }

        var detected = {};
        function renderPerson(dev) {
            if(detected[dev.address]) return; // Cegah duplikat
            detected[dev.address] = dev;
            
            var name = dev.name || "Unknown Agent";
            var el = document.getElementById('list-nearby');
            
            // Tampilan Card Orang
            var html = `
            <div class="list-item" onclick="japri('${dev.address}', '${name}')">
                <div class="avatar-circle"><i class="fas fa-user"></i><div class="online-dot"></div></div>
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:16px;">${name}</div>
                    <div style="font-size:12px; color:var(--primary);">Tap untuk Japri</div>
                </div>
                <i class="fas fa-comment-dots" style="color:#ccc;"></i>
            </div>`;
            el.innerHTML += html;
        }

        // --- JAPRI LOGIC ---
        function japri(addr, name) {
            activeAddr = addr;
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('chat-title').innerText = name;
            document.getElementById('msgs').innerHTML = ""; // Bersihkan chat lama
            
            // Konek ke HP teman
            ble.connect({ address:addr }, function(res){
                if(res.status === 'connected') {
                    // Dengerin Pesan
                    ble.subscribe({ address:addr, service:MESH_SERVICE, characteristic:MESH_CHAR }, function(data){
                        if(data.value) {
                            var txt = atob(data.value); // Decode
                            addBubble(txt, 'other');
                        }
                    }, function(){});
                }
            }, function(){ alert("Gagal Konek. Pastikan dia masih di sekitar."); });
        }

        function sendMsg() {
            var t = document.getElementById('chat-input').value;
            if(!t) return;
            
            var b64 = btoa(t); // Encode Text ke Base64
            
            ble.write({ 
                address:activeAddr, 
                service:MESH_SERVICE, 
                characteristic:MESH_CHAR, 
                value:b64, 
                type:"noResponse" 
            }, function(){
                addBubble(t, 'me');
                document.getElementById('chat-input').value="";
            }, function(e){ alert("Gagal kirim: "+JSON.stringify(e)); });
        }

        function addBubble(txt, who) {
            var d = document.createElement('div'); 
            d.className="bubble "+who; 
            d.innerText=txt;
            document.getElementById('msgs').appendChild(d);
            document.getElementById('msgs').scrollTop = 99999;
        }

        function closeChat() {
            document.getElementById('chat-screen').style.display='none';
            if(activeAddr) ble.disconnect({address:activeAddr});
        }

        // --- UTILS ---
        function nav(p) {
            document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            document.getElementById('p-'+p).classList.add('active');
            document.getElementById('n-'+p).classList.add('active');
        }
        function toggleTheme() {
            if(document.body.getAttribute('data-theme')==='dark') document.body.removeAttribute('data-theme');
            else document.body.setAttribute('data-theme','dark');
        }
    </script>
</body>
</html>
