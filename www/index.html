<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; media-src *; img-src * data: content:;">
    
    <title>WA Bluetooth Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --wa-teal: #008069; --wa-bg: #e5ddd5; --me-bg: #dcf8c6; --other-bg: #ffffff; --tick-gray: #999; --tick-blue: #34B7F1; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: Helvetica, Arial, sans-serif; background: #d1d7db; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }

        /* HEADER */
        header { background: var(--wa-teal); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .app-title { font-weight: bold; font-size: 20px; }
        .tabs { display: flex; background: var(--wa-teal); }
        .tab { flex: 1; text-align: center; padding: 12px; color: rgba(255,255,255,0.6); text-transform: uppercase; font-weight: bold; font-size: 13px; border-bottom: 3px solid transparent; cursor: pointer; }
        .tab.active { color: white; border-bottom: 3px solid white; }

        /* MAIN */
        #main-container { flex: 1; position: relative; overflow: hidden; background: white; }
        .list-view { height: 100%; overflow-y: auto; display: none; }
        .list-view.active { display: block; }
        
        .device-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; cursor: pointer; }
        .device-item:active { background: #f5f5f5; }
        .avatar { width: 45px; height: 45px; background: #ddd; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 20px; margin-right: 15px; }
        .info .name { font-weight: bold; font-size: 16px; color: #333; }
        .info .addr { font-size: 12px; color: #888; margin-top: 2px; }

        /* CHAT ROOM */
        #chat-room { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--wa-bg); z-index: 100; display: none; flex-direction: column; }
        .chat-header { background: var(--wa-teal); padding: 8px 10px; display: flex; align-items: center; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .back-btn { padding: 8px; cursor: pointer; margin-right: 5px; border-radius: 50%; }
        .back-btn:active { background: rgba(255,255,255,0.2); }
        .chat-title { font-weight: bold; font-size: 18px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }

        /* PESAN */
        #msg-area { flex: 1; overflow-y: auto; padding: 10px 10px 20px 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: cover; display: flex; flex-direction: column; }
        
        .msg { max-width: 80%; padding: 6px 8px 6px 10px; margin-bottom: 6px; border-radius: 8px; font-size: 15px; position: relative; word-wrap: break-word; box-shadow: 0 1px 1px rgba(0,0,0,0.1); display: inline-block; min-width: 80px; }
        .msg.me { align-self: flex-end; background: var(--me-bg); border-top-right-radius: 0; }
        .msg.other { align-self: flex-start; background: var(--other-bg); border-top-left-radius: 0; }
        
        .msg img { max-width: 100%; border-radius: 5px; margin-top: 5px; display: block; margin-bottom: 5px; }
        
        /* Metadata (Jam & Centang) */
        .meta { display: flex; justify-content: flex-end; align-items: center; margin-top: -2px; float: right; margin-left: 8px; }
        .time { font-size: 10px; color: #999; margin-right: 3px; }
        .tick { font-size: 10px; color: var(--tick-gray); display: none; } /* Default sembunyi */
        .msg.me .tick { display: inline-block; } /* Cuma pesan kita yg ada centang */
        .tick.read { color: var(--tick-blue); }

        /* INPUT BAR */
        .chat-footer { background: #f0f0f0; padding: 5px 8px; display: flex; align-items: flex-end; gap: 6px; min-height: 50px; }
        #input-box { flex: 1; background: white; border-radius: 22px; padding: 10px 15px; border: none; outline: none; font-size: 16px; max-height: 100px; overflow-y: auto; resize: none; min-height: 40px; }
        .icon-btn { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; border-radius: 50%; color: #666; cursor: pointer; font-size: 20px; }
        .send-btn { background: var(--wa-teal); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* LOADING */
        #loading { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.85); z-index:999; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--wa-teal); border-radius: 50%; width: 35px; height: 35px; animation: spin 0.8s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header>
        <div class="app-title">WA Bluetooth</div>
        <i class="fas fa-ellipsis-v"></i>
    </header>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('personal')" id="tab-personal">Personal</div>
        <div class="tab" onclick="switchTab('nearby')" id="tab-nearby">Sekitar</div>
    </div>

    <div id="main-container">
        <div id="view-personal" class="list-view active">
            <div style="padding:20px; text-align:center; color:#999;" id="status-personal">Memuat...</div>
        </div>
        <div id="view-nearby" class="list-view">
            <div style="padding:15px; background:#e3f2fd; color:#0d47a1; font-size:12px; display:flex; align-items:center;">
                <i class="fas fa-search-location" style="margin-right:10px; font-size:16px;"></i>
                Scan perangkat Bluetooth aktif di sekitar.
            </div>
            <button onclick="scanNearby()" style="width:90%; margin:10px 5%; padding:12px; background:var(--wa-teal); color:white; border:none; border-radius:5px; font-weight:bold;">SCAN ULANG</button>
            <div id="list-nearby"></div>
        </div>
    </div>

    <div id="chat-room">
        <div class="chat-header">
            <i class="fas fa-arrow-left back-btn" onclick="closeChat()"></i>
            <div class="avatar" style="width:35px; height:35px; font-size:16px; margin-right:10px;"><i class="fas fa-user"></i></div>
            <div class="chat-title" id="room-name">Nama Kontak</div>
        </div>

        <div id="msg-area">
            <div style="text-align:center; margin-top:20px; font-size:11px; color:#555; background:rgba(255,248,200,0.8); padding:5px 10px; border-radius:8px; display:inline-block; align-self:center; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                <i class="fas fa-lock" style="font-size:10px;"></i> Pesan terenkripsi end-to-end (Offline)
            </div>
        </div>

        <div class="chat-footer">
            <div class="icon-btn" onclick="pilihGambar()"><i class="fas fa-paperclip" style="transform: rotate(45deg);"></i></div>
            <textarea id="input-box" placeholder="Ketik pesan..." rows="1"></textarea>
            <div class="icon-btn send-btn" onclick="kirimPesan()"><i class="fas fa-paper-plane"></i></div>
        </div>
    </div>

    <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="prosesGambar(this)">

    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text" style="font-weight:bold; color:#555;">Memproses...</div>
    </div>

    <script type="text/javascript" src="cordova.js"></script>
    <script>
        var bt;
        
        document.addEventListener('deviceready', function() {
            bt = window.bluetoothClassicSerialPort;
            
            // Setup & Izin
            mintaIzin();
            aktifkanServer();
            
            // Auto-Resize Textarea
            const tx = document.getElementById('input-box');
            tx.addEventListener("input", function() {
                this.style.height = "auto";
                this.style.height = (this.scrollHeight) + "px";
                if(this.value === "") this.style.height = "40px";
            });

            loadPersonal();
        }, false);

        // --- CORE BLUETOOTH ---
        function mintaIzin() {
            var p = cordova.plugins.permissions;
            var list = [ p.BLUETOOTH_SCAN, p.BLUETOOTH_CONNECT, p.BLUETOOTH_ADVERTISE, p.ACCESS_FINE_LOCATION ];
            p.checkPermission(list, function(s){
                if(!s.hasPermission) p.requestPermissions(list, function(s){}, function(e){});
            });
        }

        function aktifkanServer() {
            // Standby menerima koneksi
            bt.listen(function() {}, function(e){ console.error(e); });
            
            // DENGAR PESAN MASUK
            bt.subscribe('\n', function(data) {
                olahDataMasuk(data);
            });
        }

        // --- UI LOGIC ---
        function switchTab(t) {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.list-view').forEach(x => x.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.getElementById('view-'+t).classList.add('active');
            if(t==='personal') loadPersonal();
        }

        function loadPersonal() {
            bt.list(function(d) {
                renderList(d, 'view-personal');
                document.getElementById('status-personal').style.display = (d.length===0)?'block':'none';
                if(d.length===0) document.getElementById('status-personal').innerText = "Belum ada perangkat dipairing.";
            }, function(){});
        }

        function scanNearby() {
            document.getElementById('list-nearby').innerHTML = "<div style='padding:20px; text-align:center;'>Sedang mencari...</div>";
            bt.discoverUnpaired(function(d) {
                renderList(d, 'list-nearby');
                if(d.length===0) document.getElementById('list-nearby').innerHTML = "<div style='padding:20px; text-align:center;'>Tidak ada perangkat.</div>";
            }, function(e){ alert("Gagal scan: "+e); });
        }

        function renderList(devices, target) {
            var el = document.getElementById(target);
            if(target === 'view-personal') el.innerHTML = '<div style="padding:20px; text-align:center; display:none;" id="status-personal"></div>';
            else el.innerHTML = "";

            devices.forEach(d => {
                if(!d.name) return;
                el.innerHTML += `
                <div class="device-item" onclick="connectTo('${d.address}', '${d.name}')">
                    <div class="avatar"><i class="fas fa-user"></i></div>
                    <div class="info"><div class="name">${d.name}</div><div class="addr">${d.address}</div></div>
                </div>`;
            });
        }

        // --- KONEKSI ---
        function connectTo(address, name) {
            showLoading("Menghubungkan...");
            bt.connectInsecure(address, function() {
                hideLoading();
                bukaChat(name);
            }, function(e) {
                hideLoading();
                alert("Gagal konek: "+e+"\nPastikan teman membuka aplikasi ini!");
            });
        }

        function bukaChat(name) {
            document.getElementById('room-name').innerText = name;
            document.getElementById('chat-room').style.display = 'flex';
            document.getElementById('msg-area').innerHTML = ""; 
        }

        function closeChat() {
            bt.disconnect();
            document.getElementById('chat-room').style.display = 'none';
        }

        // --- KIRIM PESAN & GAMBAR (DENGAN ID UNTUK CEKLIS) ---
        
        function kirimPesan() {
            var input = document.getElementById('input-box');
            var text = input.value.trim();
            if(!text) return;

            // Generate ID Unik (Pakai Waktu)
            var msgId = Date.now(); 

            // Format Protokol: TXT:MSG_ID:IsiPesan
            var paket = "TXT:" + msgId + ":" + text + "\n";
            
            bt.write(paket, function() {
                // Sukses Kirim -> Tampilkan Centang 1 (Abu)
                tambahBubble(text, "me", "text", msgId, false);
                input.value = "";
                input.style.height = "40px";
            }, function(e){ alert("Gagal kirim: "+e); });
        }

        function prosesGambar(input) {
            if (input.files && input.files[0]) {
                showLoading("Mengompres...");
                var reader = new FileReader();
                reader.onload = function (e) {
                    var img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        var canvas = document.createElement('canvas');
                        var ctx = canvas.getContext('2d');
                        var scale = 300 / img.width; // Resize lebar jadi 300px
                        canvas.width = 300;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        var base64 = canvas.toDataURL('image/jpeg', 0.6); // Kompres Quality 60%
                        
                        var msgId = Date.now();
                        // Format: IMG:MSG_ID:Base64String
                        bt.write("IMG:" + msgId + ":" + base64 + "\n", function() {
                            hideLoading();
                            tambahBubble(base64, "me", "image", msgId, false);
                        }, function(e){ hideLoading(); alert("Gagal kirim: "+e); });
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function pilihGambar() { document.getElementById('file-input').click(); }

        // --- TERIMA DATA & CEKLIS ---
        
        function olahDataMasuk(raw) {
            // Cek Tipe Data
            if(raw.startsWith("ACK:")) {
                // INI ADALAH LAPORAN DIBACA (Ceklis Biru)
                var idDibaca = raw.split(":")[1].trim();
                updateCentangBiru(idDibaca);
            } 
            else if(raw.startsWith("TXT:")) {
                // TERIMA TEKS
                // Format: TXT:ID:Pesan
                var parts = raw.split(":");
                var id = parts[1]; 
                var isi = raw.substring(parts[0].length + parts[1].length + 2); // Ambil sisanya
                
                tambahBubble(isi, "other", "text", id);
                kirimLaporanDibaca(id); // Langsung lapor balik "Sudah Baca"
            } 
            else if (raw.startsWith("IMG:")) {
                // TERIMA GAMBAR
                var parts = raw.split(":");
                var id = parts[1];
                var isi = raw.substring(parts[0].length + parts[1].length + 2);

                tambahBubble(isi, "other", "image", id);
                kirimLaporanDibaca(id); // Langsung lapor balik
            }
        }

        function kirimLaporanDibaca(msgId) {
            // Kirim sinyal ACK balik ke pengirim
            bt.write("ACK:" + msgId + "\n", function(){}, function(){});
        }

        function updateCentangBiru(id) {
            // Cari bubble dengan ID tersebut
            var tickElement = document.getElementById("tick-" + id);
            if(tickElement) {
                tickElement.classList.add("read"); // Tambah class biru
                tickElement.className = "fas fa-check-double tick read"; // Ubah icon jadi double
            }
        }

        // --- RENDER BUBBLE CHAT ---
        function tambahBubble(content, who, type, msgId, isRead) {
            var area = document.getElementById('msg-area');
            var div = document.createElement('div');
            div.className = "msg " + who;
            
            var time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Icon Centang (Default: Centang 1 Check)
            // ID Element Centang: tick-{msgId}
            var tickHtml = `<i id="tick-${msgId}" class="fas fa-check tick"></i>`; 
            
            if (type === "text") {
                div.innerHTML = `${content} <div class="meta"><span class="time">${time}</span> ${tickHtml}</div>`;
            } else {
                div.innerHTML = `<img src="${content}"> <div class="meta"><span class="time">${time}</span> ${tickHtml}</div>`;
            }
            
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function showLoading(t) { document.getElementById('loading').style.display = 'flex'; document.getElementById('loading-text').innerText = t; }
        function hideLoading() { document.getElementById('loading').style.display = 'none'; }

    </script>
</body>
</html>
