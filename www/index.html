<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; media-src *; img-src * data: content: https://*.openstreetmap.org;">
    
    <title>Messenger Mesh</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --primary: #2563eb;
            --bg-app: #f8f9fa;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --nav-bg: #ffffff;
            --bubble-me: #2563eb;
            --text-me: #ffffff;
            --bubble-other: #f3f4f6;
            --text-other: #1f2937;
        }

        [data-theme="dark"] {
            --primary: #3b82f6;
            --bg-app: #111827;
            --bg-card: #1f2937;
            --text-main: #f9fafb;
            --text-sub: #9ca3af;
            --border: #374151;
            --nav-bg: #1f2937;
            --bubble-me: #2563eb;
            --text-me: #ffffff;
            --bubble-other: #374151;
            --text-other: #e5e7eb;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { padding: 20px 20px 10px 20px; background: var(--bg-app); display: flex; align-items: center; justify-content: space-between; z-index: 10; }
        .head-title { font-size: 24px; font-weight: 700; color: var(--text-main); }
        .head-sub { font-size: 12px; color: var(--text-sub); }
        .radar-badge { font-size: 10px; background: rgba(37, 99, 235, 0.1); color: var(--primary); padding: 4px 8px; border-radius: 20px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .pulse { width: 6px; height: 6px; background: var(--primary); border-radius: 50%; animation: ping 1.5s infinite; }
        @keyframes ping { 0%{transform:scale(1);opacity:1} 100%{transform:scale(2);opacity:0} }

        /* PAGES */
        #pages-container { flex: 1; position: relative; overflow: hidden; }
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; display: none; padding-bottom: 100px; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* LIST & EMPTY STATE */
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80%; text-align: center; padding: 20px; }
        .empty-icon { width: 80px; height: 80px; background: var(--bg-card); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; color: var(--text-sub); margin-bottom: 20px; }
        .btn-blue { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }

        .list-item { padding: 15px 20px; display: flex; align-items: center; border-bottom: 1px solid var(--border); background: var(--bg-card); cursor: pointer; }
        .avatar { width: 48px; height: 48px; background: linear-gradient(135deg, #60a5fa, #2563eb); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 15px; position: relative; }
        .online-dot { width: 12px; height: 12px; background: #10b981; border: 2px solid var(--bg-card); border-radius: 50%; position: absolute; bottom: 0; right: 0; }
        .item-info { flex: 1; }
        .item-name { font-weight: 600; font-size: 16px; }
        .item-sub { font-size: 13px; color: var(--text-sub); }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 20px; left: 20px; right: 20px; background: var(--nav-bg); padding: 15px; border-radius: 20px; display: flex; justify-content: space-around; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); font-size: 10px; font-weight: 600; gap: 5px; cursor: pointer; }
        .nav-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active .nav-icon { background: var(--primary); color: white; }

        /* PROFILE SECTION */
        .profile-card { background: var(--bg-card); margin: 20px; padding: 25px; border-radius: 20px; text-align: center; border: 1px solid var(--border); position: relative; }
        .big-avatar { width: 80px; height: 80px; background: #e0f2fe; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 15px; }
        
        .profile-name-box { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 5px; }
        .profile-name { font-size: 18px; font-weight: 700; color: var(--text-main); }
        .edit-icon { color: var(--primary); cursor: pointer; font-size: 14px; padding: 5px; }
        
        .profile-addr { font-size: 12px; color: var(--text-sub); background: var(--bg-app); padding: 6px 12px; border-radius: 20px; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 20px; }
        
        .menu-list { margin: 20px; background: var(--bg-card); border-radius: 16px; overflow: hidden; border: 1px solid var(--border); }
        .menu-item { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); font-weight: 500; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* MODAL EDIT NAMA */
        #edit-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:200; display:none; justify-content:center; align-items:center; }
        .modal-box { background:var(--bg-card); padding:25px; border-radius:20px; width:80%; text-align:center; }
        .modal-input { width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; margin:15px 0; font-size:16px; background:var(--bg-app); color:var(--text-main); }
        .modal-btns { display:flex; gap:10px; justify-content:center; }

        /* CHAT ROOM */
        #chat-room { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-app); z-index: 100; display: none; flex-direction: column; }
        .chat-header { background: var(--bg-card); padding: 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border); }
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .bubble { max-width: 75%; padding: 12px 16px; border-radius: 16px; font-size: 14px; position: relative; word-wrap: break-word; }
        .bubble.me { align-self: flex-end; background: var(--bubble-me); color: var(--text-me); border-bottom-right-radius: 2px; }
        .bubble.other { align-self: flex-start; background: var(--bubble-other); color: var(--text-other); border-bottom-left-radius: 2px; }
        .chat-input-bar { background: var(--bg-card); padding: 10px 15px; display: flex; align-items: flex-end; gap: 10px; border-top: 1px solid var(--border); }
        textarea { flex: 1; background: var(--bg-app); border: none; padding: 12px 15px; border-radius: 20px; resize: none; max-height: 100px; color: var(--text-main); font-size: 15px; }
        .action-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: var(--text-sub); cursor: pointer; font-size: 20px; }
        .send-btn { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <header id="main-header">
        <div>
            <div class="head-title">Pesan</div>
            <div class="head-sub" id="header-status">Siap Menghubungkan</div>
        </div>
        <div class="radar-badge"><div class="pulse"></div> Visible</div>
    </header>

    <div id="pages-container">
        <div id="page-chat" class="page active">
            <div id="empty-state-chat" class="empty-state">
                <div class="empty-icon"><i class="far fa-comment-dots"></i></div>
                <div class="empty-title">Belum Ada Percakapan</div>
                <div class="empty-desc">Scan teman di sekitar untuk memulai chat offline.</div>
                <button class="btn-blue" onclick="nav('global')"><i class="fas fa-search-location"></i> Cari Teman</button>
            </div>
            <div id="list-paired"></div>
        </div>

        <div id="page-global" class="page">
            <div style="padding: 20px;">
                <div style="background: var(--bg-card); padding: 20px; border-radius: 16px; border: 1px solid var(--border); text-align: center;">
                    <i class="fas fa-satellite-dish" style="font-size: 40px; color: var(--primary); margin-bottom: 10px;"></i>
                    <h3 style="margin:0;">Radar Mesh</h3>
                    <p style="color:var(--text-sub); font-size:13px;">Mencari perangkat di sekitar...</p>
                    <button class="btn-blue" onclick="forceScan()" style="margin-top:10px; width:100%; justify-content:center;">SCAN ULANG</button>
                </div>
            </div>
            <div id="list-nearby"></div>
        </div>

        <div id="page-profile" class="page">
            <div class="profile-card">
                <div class="big-avatar"><i class="fas fa-user"></i></div>
                
                <div class="profile-name-box">
                    <div class="profile-name" id="display-name">User Mesh</div>
                    <i class="fas fa-pen edit-icon" onclick="openEditName()"></i>
                </div>

                <div class="profile-addr" id="location-badge" onclick="refreshLocation()">
                    <i class="fas fa-map-marker-alt"></i> <span id="loc-text">Mendeteksi Lokasi...</span>
                </div>
                
                <div style="color: #10b981; font-weight: 600; font-size: 14px;">Akun Lokal Aktif âœ“</div>
            </div>

            <div class="menu-list">
                <div class="menu-item">
                    <span><i class="fas fa-moon" style="margin-right:10px; color:var(--primary);"></i> Dark Mode</span>
                    <label class="switch">
                        <input type="checkbox" id="theme-toggle" onchange="toggleTheme()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="menu-item" onclick="refreshLocation()">
                    <span><i class="fas fa-sync" style="margin-right:10px; color:var(--text-sub);"></i> Update Lokasi</span>
                    <i class="fas fa-chevron-right" style="color:var(--text-sub); font-size:12px;"></i>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-modal">
        <div class="modal-box">
            <h3>Ganti Nama</h3>
            <input type="text" id="new-name-input" class="modal-input" placeholder="Masukkan nama baru">
            <div class="modal-btns">
                <button class="btn-blue" style="background:#ccc; color:#333;" onclick="closeEditName()">Batal</button>
                <button class="btn-blue" onclick="saveName()">Simpan</button>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" id="nav-chat" onclick="nav('chat')">
            <div class="nav-icon"><i class="fas fa-comment-alt"></i></div>
            <span>Chats</span>
        </div>
        <div class="nav-item" id="nav-global" onclick="nav('global')">
            <div class="nav-icon"><i class="fas fa-globe"></i></div>
            <span>Global</span>
        </div>
        <div class="nav-item" id="nav-profile" onclick="nav('profile')">
            <div class="nav-icon"><i class="fas fa-user"></i></div>
            <span>Profile</span>
        </div>
    </div>

    <div id="chat-room">
        <div class="chat-header">
            <i class="fas fa-arrow-left" style="font-size: 20px; color: var(--text-main); cursor: pointer;" onclick="closeChat()"></i>
            <div style="flex:1;">
                <div style="font-weight: 700; font-size: 16px;" id="chat-name">User</div>
                <div style="font-size: 12px; color: #10b981;">Online</div>
            </div>
        </div>
        <div class="chat-area" id="msgs"></div>
        <div class="chat-input-bar">
            <textarea id="txt" placeholder="Ketik pesan..." rows="1"></textarea>
            <div class="action-btn send-btn" onclick="sendText()"><i class="fas fa-paper-plane"></i></div>
        </div>
    </div>

    <script type="text/javascript" src="cordova.js"></script>
    <script>
        var bt = null;

        document.addEventListener('deviceready', function() {
            bt = window.bluetoothClassicSerialPort;
            
            // Init Fitur
            initPermissions();
            loadProfileData(); // Load Nama & Tema
            refreshLocation(); // Auto Deteksi Lokasi

            // Dark Mode Check
            if(localStorage.getItem('theme') === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('theme-toggle').checked = true;
            }
        }, false);

        // --- FITUR PROFILE (NAMA & LOKASI) ---
        
        function loadProfileData() {
            // Ambil nama dari penyimpanan HP
            var savedName = localStorage.getItem('mesh_username');
            if(savedName) {
                document.getElementById('display-name').innerText = savedName;
            }
        }

        function openEditName() {
            document.getElementById('edit-modal').style.display = 'flex';
            document.getElementById('new-name-input').value = document.getElementById('display-name').innerText;
        }

        function closeEditName() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function saveName() {
            var newName = document.getElementById('new-name-input').value.trim();
            if(newName) {
                localStorage.setItem('mesh_username', newName); // Simpan Permanen
                document.getElementById('display-name').innerText = newName;
                closeEditName();
            }
        }

        function refreshLocation() {
            document.getElementById('loc-text').innerText = "Mencari GPS...";
            
            // Cek Izin & Ambil Lokasi
            navigator.geolocation.getCurrentPosition(function(pos) {
                var lat = pos.coords.latitude.toFixed(4);
                var lon = pos.coords.longitude.toFixed(4);
                
                // Coba ubah koordinat jadi Nama Kota (Butuh Internet dikit buat API)
                // Kalau offline, dia bakal nampilin Koordinat aja
                fetchCityName(lat, lon);
                
            }, function(err) {
                document.getElementById('loc-text').innerText = "Lokasi Tidak Dikenal";
                alert("Gagal deteksi lokasi: Pastikan GPS Nyala!");
            }, { enableHighAccuracy: true });
        }

        function fetchCityName(lat, lon) {
            // Trik: Coba fetch ke OpenStreetMap (Gratis)
            // Kalau offline, dia masuk ke 'catch' dan nampilin LatLong
            var url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var city = data.address.city || data.address.town || data.address.village || "Lokasi Terdeteksi";
                    document.getElementById('loc-text').innerText = city; // Contoh: "Jakarta Utara"
                })
                .catch(err => {
                    // Kalau Offline / Gak ada kuota
                    document.getElementById('loc-text').innerText = `${lat}, ${lon}`; 
                });
        }

        function toggleTheme() {
            if(document.body.hasAttribute('data-theme')) {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        // --- BLUETOOTH CORE ---
        function initPermissions() {
            var p = cordova.plugins.permissions;
            var list = [
                "android.permission.BLUETOOTH_SCAN", 
                "android.permission.BLUETOOTH_CONNECT", 
                "android.permission.BLUETOOTH_ADVERTISE",
                "android.permission.ACCESS_FINE_LOCATION" // Wajib buat GPS
            ];
            p.requestPermissions(list, function(s){
                if(s.hasPermission) {
                    bt.setDiscoverable(0);
                    bt.listen(function(){}, function(){});
                    bt.subscribeRaw(handleData);
                    loadPaired();
                }
            }, function(){});
        }

        function nav(page) {
            document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            document.getElementById('page-'+page).classList.add('active');
            document.getElementById('nav-'+page).classList.add('active');
            
            var titles = {'chat':'Pesan', 'global':'Radar Mesh', 'profile':'Profil Pengguna'};
            document.querySelector('.head-title').innerText = titles[page];
            
            if(page === 'global') forceScan();
        }

        function forceScan() {
            var el = document.getElementById('list-nearby');
            el.innerHTML = "<p style='text-align:center; color:#888;'>Scanning...</p>";
            bt.discoverUnpaired(function(devs){
                el.innerHTML = "";
                devs.forEach(d => {
                    if(!d.name) return;
                    el.innerHTML += `<div class="list-item" onclick="connect('${d.address}', '${d.name}')">
                        <div class="avatar"><i class="fas fa-mobile-alt"></i></div>
                        <div class="item-info"><div class="item-name">${d.name}</div><div class="item-sub">Tap Connect</div></div>
                    </div>`;
                });
            }, function(){ el.innerHTML = "Gagal Scan"; });
        }

        function loadPaired() {
            bt.list(function(devs){
                var el = document.getElementById('list-paired');
                var empty = document.getElementById('empty-state-chat');
                if(devs.length>0) {
                    empty.style.display='none';
                    el.innerHTML="";
                    devs.forEach(d=>{
                        el.innerHTML += `<div class="list-item" onclick="connect('${d.address}', '${d.name}')">
                            <div class="avatar"><i class="fas fa-user"></i></div>
                            <div class="item-info"><div class="item-name">${d.name}</div><div class="item-sub">Tersimpan</div></div>
                        </div>`;
                    });
                } else { empty.style.display='flex'; }
            }, function(){});
        }

        function connect(addr, name) {
            bt.connectInsecure(addr, function(){
                document.getElementById('chat-room').style.display='flex';
                document.getElementById('chat-name').innerText=name;
                document.getElementById('msgs').innerHTML="";
            }, function(e){ alert("Gagal: "+e); });
        }

        function closeChat() {
            bt.disconnect();
            document.getElementById('chat-room').style.display='none';
        }

        function sendText() {
            var t = document.getElementById('txt').value;
            if(t.trim()) {
                bt.write("TXT:"+t, function(){
                    var d = document.createElement('div'); d.className='bubble me'; d.innerText=t;
                    document.getElementById('msgs').appendChild(d);
                    document.getElementById('txt').value="";
                }, null);
            }
        }

        function handleData(buffer) {
            var s = String.fromCharCode.apply(null, new Uint8Array(buffer));
            if(s.startsWith("TXT:")) {
                var d = document.createElement('div'); d.className='bubble other'; d.innerText=s.substring(4);
                document.getElementById('msgs').appendChild(d);
            }
        }
    </script>
</body>
    </html>
